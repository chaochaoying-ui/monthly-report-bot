# 错题本使用指南

## 📖 概述

为了避免重复犯错，我们建立了一套完整的错误跟踪和预防机制：

1. **错题本** ([PITFALLS_AND_SOLUTIONS.md](PITFALLS_AND_SOLUTIONS.md)) - 记录所有遇到的坑和解决方案
2. **部署检查清单** ([PRE_DEPLOY_CHECKLIST.md](PRE_DEPLOY_CHECKLIST.md)) - 部署前强制检查
3. **错误记录工具** ([add_pitfall.py](add_pitfall.py)) - 快速添加新的错误记录

---

## 🚀 快速开始

### 1. 开发前：阅读错题本

**每次开始开发前**，先运行：

```bash
# 打开错题本，快速浏览相关章节
code PITFALLS_AND_SOLUTIONS.md

# 或者在终端中查看
cat PITFALLS_AND_SOLUTIONS.md | grep -A 20 "核心架构问题"
```

**重点关注**：
- 你即将修改的模块的相关问题
- 严重程度标记为 🔴（极高）和 🟡（中等）的坑

---

### 2. 开发中：参考已验证的代码

遇到问题时：

**✅ 正确做法**：
1. 先查看错题本中是否有类似问题
2. 参考项目中已验证的代码（如 `monthly_report_bot_final_interactive.py`）
3. 阅读相关文档和错误日志

**❌ 错误做法**：
1. ❌ 不停地尝试各种参数组合
2. ❌ 盲目搜索网络上的方案
3. ❌ 修改不理解的代码

---

### 3. 部署前：运行检查清单

**每次部署前**，必须完成 [PRE_DEPLOY_CHECKLIST.md](PRE_DEPLOY_CHECKLIST.md) 中的所有检查项：

```bash
# 打开检查清单
code PRE_DEPLOY_CHECKLIST.md

# 或者打印出来，逐项打勾
```

**关键检查项**：
- ✅ 已阅读错题本
- ✅ 代码通过语法检查
- ✅ 环境变量格式正确
- ✅ 已备份关键文件
- ✅ Git 提交信息清晰
- ✅ 准备好回滚方案

---

### 4. 遇到新问题：记录到错题本

**方法A：使用自动化工具（推荐）**

```bash
# 运行错误记录工具
python3 add_pitfall.py
```

按照提示输入：
1. 选择类别（1-7）
2. 问题简述
3. 详细描述
4. 影响
5. 根本原因
6. 错误尝试（可选）
7. 正确做法
8. 关键点
9. 严重程度

工具会自动生成格式化的Markdown条目并添加到错题本。

**方法B：手动编辑**

直接编辑 `PITFALLS_AND_SOLUTIONS.md`，在"新增错误记录区"添加：

```markdown
### ❌ 坑 #X.Y: [问题简述]

**发现时间**: 2025-MM-DD
**问题描述**: ...
**根本原因**: ...
**解决方案**: ...
**关键点**: ...
**严重程度**: 🔴/🟡/🟢

---
```

然后手动移动到相应章节。

---

## 📂 文件说明

### 1. PITFALLS_AND_SOLUTIONS.md
**用途**: 错题本主文件
**更新频率**: 每次遇到新问题后更新
**章节结构**:
- 核心架构问题
- 部署相关问题
- 环境变量问题
- 飞书API调用问题
- 数据同步问题
- 字体和图表问题
- 服务器运维问题

**使用场景**:
- 开发前：快速浏览相关章节
- 遇到问题：搜索类似问题的解决方案
- 代码审查：检查是否重复犯错

### 2. PRE_DEPLOY_CHECKLIST.md
**用途**: 部署前强制检查清单
**使用频率**: 每次部署前必须完成
**检查阶段**:
1. 部署前准备
2. Git版本控制
3. 服务器部署
4. 服务重启
5. 功能验证
6. 回滚准备

**使用场景**:
- 部署前：逐项核对所有检查项
- 部署后：记录部署信息和结果
- 回滚时：参考回滚指南

### 3. add_pitfall.py
**用途**: 错误记录自动化工具
**使用频率**: 每次解决新问题后使用
**功能**:
- 交互式收集问题信息
- 自动生成格式化的Markdown
- 直接添加到错题本

**使用场景**:
- 解决问题后立即记录
- 确保记录格式统一
- 节省手动编辑时间

---

## 🔄 工作流程

### 完整的开发-部署流程

```
1. 开发前
   ├─ 阅读 PITFALLS_AND_SOLUTIONS.md
   ├─ 了解相关模块的常见问题
   └─ 参考已验证的代码

2. 开发中
   ├─ 编写代码
   ├─ 遇到问题 → 查错题本 → 参考正确做法
   └─ 本地测试

3. 解决问题后
   ├─ 运行 python3 add_pitfall.py
   ├─ 记录问题和解决方案
   └─ 更新错题本

4. 部署前
   ├─ 打开 PRE_DEPLOY_CHECKLIST.md
   ├─ 逐项完成所有检查
   └─ 全部通过后才能部署

5. 部署
   ├─ 按照检查清单的步骤执行
   ├─ 备份 → 推送 → 拉取 → 重启
   └─ 查看日志确认

6. 部署后
   ├─ 功能验证测试
   ├─ 记录部署结果
   └─ 如有问题立即回滚
```

---

## 🎯 最佳实践

### 1. 阅读习惯
- ✅ 每周一阅读一次完整的错题本
- ✅ 开发前快速浏览相关章节
- ✅ 遇到问题先搜索错题本

### 2. 记录习惯
- ✅ 问题解决后立即记录
- ✅ 包含详细的问题描述和解决方案
- ✅ 标注严重程度和修复时间
- ✅ 添加验证方法

### 3. 检查习惯
- ✅ 部署前完成所有检查项（不跳过）
- ✅ 保留检查清单的纸质版或电子版
- ✅ 记录每次部署的结果
- ✅ 定期审查和更新检查清单

### 4. 团队协作
- ✅ 分享错题本给团队成员
- ✅ 定期讨论最近的问题和解决方案
- ✅ 鼓励所有人贡献经验
- ✅ 代码审查时参考错题本

---

## 📊 错误统计

### 当前记录的问题分类

| 类别 | 数量 | 严重程度分布 |
|------|------|--------------|
| 核心架构问题 | 2 | 🔴x2 |
| 部署相关问题 | 3 | 🟡x2, 🟢x1 |
| 环境变量问题 | 2 | 🔴x1, 🟡x1 |
| 飞书API调用问题 | 2 | 🟡x2 |
| 数据同步问题 | 2 | 🔴x2 |
| 字体和图表问题 | 2 | 🟡x2 |
| 服务器运维问题 | 3 | 🟡x1, 🟢x2 |

**总计**: 16个已知问题

**严重程度**:
- 🔴 极高: 5个（31%）
- 🟡 中等: 8个（50%）
- 🟢 低: 3个（19%）

---

## 🆕 更新日志

### 2025-10-23
- ✅ 创建初始版本的错题本
- ✅ 记录16个已知问题和解决方案
- ✅ 创建部署检查清单
- ✅ 创建错误记录自动化工具

### 未来计划
- [ ] 添加更多代码示例
- [ ] 创建视频教程
- [ ] 建立常见问题FAQ
- [ ] 自动化更多检查项

---

## 💡 提示

### 快速搜索技巧

**在 VS Code 中**:
```
Ctrl+F (或 Cmd+F)
搜索关键词，如: "任务ID", "环境变量", "API调用"
```

**在终端中**:
```bash
# 搜索特定问题
grep -n "模拟任务ID" PITFALLS_AND_SOLUTIONS.md

# 搜索所有极高严重度的问题
grep -B 3 "🔴 极高" PITFALLS_AND_SOLUTIONS.md

# 查看目录结构
grep "^##" PITFALLS_AND_SOLUTIONS.md
```

### 快速参考卡片

**环境变量格式**:
```bash
✅ APP_ID=cli_...
✅ APP_SECRET=...
❌ FEISHU_APP_ID=...  # 错误格式
```

**飞书客户端初始化**:
```python
✅ lark_client = lark.Client.builder() \
      .app_id(APP_ID) \
      .app_secret(APP_SECRET) \
      .build()

❌ # 不要添加 .log_level() 参数
```

**任务ID格式**:
```
✅ b1c2d3e4-5f6a-7b8c-9d0e-1f2a3b4c5d6e  # 真实GUID
❌ task_2025-10_1                       # 模拟ID
```

**服务器路径**:
```bash
✅ /home/hdi918072/monthly-report-bot   # 连字符
✅ monthly-report-bot                   # 服务名
❌ /home/hdi918072/monthly_report_bot   # 错误（下划线）
```

---

## 🆘 获取帮助

### 遇到问题时的步骤

1. **查看错题本**: 搜索类似问题
2. **查看日志**: `sudo journalctl -u monthly-report-bot -n 100`
3. **检查服务状态**: `sudo systemctl status monthly-report-bot`
4. **参考检查清单**: [PRE_DEPLOY_CHECKLIST.md](PRE_DEPLOY_CHECKLIST.md) 的常见问题部分

### 相关文档

- [PITFALLS_AND_SOLUTIONS.md](PITFALLS_AND_SOLUTIONS.md) - 完整的错题本
- [PRE_DEPLOY_CHECKLIST.md](PRE_DEPLOY_CHECKLIST.md) - 部署检查清单
- [TASK_SYNC_FIX.md](TASK_SYNC_FIX.md) - 任务同步问题详细说明
- [QUICK_FIX_GUIDE.md](QUICK_FIX_GUIDE.md) - 快速修复指南
- [COMPLETE_FEATURES_AND_SUMMARY.md](COMPLETE_FEATURES_AND_SUMMARY.md) - 功能总结

---

**记住**:
- 🔴 开发前先看错题本
- 🔴 部署前完成检查清单
- 🔴 解决问题后立即记录

**让我们从错误中学习，避免重复犯错！** 💪
