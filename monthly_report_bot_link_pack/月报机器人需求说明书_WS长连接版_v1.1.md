# 月报机器人需求说明书（WS 长连接版 · 最终稿 v1.1）

> **单一事实来源（SSOT）**：本文件用于新仓库立项、分工、开发、验收与上线。  
> 默认时区：`America/Argentina/Buenos_Aires`。回调通道：**仅 WebSocket（WS）**。

---

## 目录
- [0. 概览](#0-概览)
- [1. 范围与不在范围](#1-范围与不在范围)
- [2. 角色与术语](#2-角色与术语)
- [3. 事件与时序（WS 回调）](#3-事件与时序ws-回调)
- [4. 功能需求（含验收标准）](#4-功能需求含验收标准)
  - [F1. 新成员欢迎卡片](#f1-新成员欢迎卡片)
  - [F2. 任务创建（17–19）](#f2-任务创建1719)
  - [F3. 月报任务卡片（18–22）](#f3-月报任务卡片1822)
  - [F4. 最终提醒（23）](#f4-最终提醒23)
- [5. 智能交互范围与验收（合并版）](#5-智能交互范围与验收合并版)
- [6. 项目亮点（对外表述 + KPI）](#6-项目亮点对外表述--kpi)
- [7. 非功能需求](#7-非功能需求)
- [8. 配置与数据](#8-配置与数据)
- [9. 卡片与交互要素](#9-卡片与交互要素)
- [10. 测试用例（最小集）](#10-测试用例最小集)
- [11. 验收标准（KPI 总表）](#11-验收标准kpi-总表)
- [12. 上线与回退](#12-上线与回退)
- [13. 里程碑与交付物](#13-里程碑与交付物)
- [14. 完成定义（DoD）](#14-完成定义dod)
- [附录 A. 术语表](#附录-a-术语表)
- [附录 B. 服务路由与权限](#附录-b-服务路由与权限)

---

## 0. 概览
- **目标**  
  1) 群聊出现**新成员加入**时，自动发送**欢迎卡片**；  
  2) 每月 **17–23 日**驱动"月报生产"全流程：**创建/分发任务 → 每日任务卡片（进度互动）→ 最终提醒**；  
  3) 回调链路**只使用飞书 WebSocket 长连接（WS）**，具备幂等、可观测、可恢复能力。

- **默认日程**  
  - 09:30 任务创建/检查（17–19 日）  
  - 09:31 月报任务卡片（18–22 日）  
  - 09:32 最终提醒（23 日）

---

## 1. 范围与不在范围
### 1.1 在范围
- 新成员入群欢迎卡片（含配置入口）
- 月报生产（17–23 日）：创建任务、每日任务卡片、最终提醒
- 仅 WS 回调（事件订阅、卡片按钮交互）
- 配置与状态（全局 + 群级覆盖）、日志与告警、补跑机制

### 1.2 不在范围（本期）
- HTTP 回调
- 第三方系统自动取数、复杂审批流/报表大屏

---

## 2. 角色与术语
- **使用者**：项目经理、专业负责人、协作人、群成员  
- **群级配置**：对某群覆盖全局默认（如推送时刻、文件链接等）  
- **幂等**：同一自然月任务只创建一次（允许失败补建但不重复）  
- **补跑**：服务恢复后自动执行**当日未完成环节**

---

## 3. 事件与时序（WS 回调）
### 3.1 事件矩阵
| 事件 | 触发 | 机器人动作 | 输出 |
|---|---|---|---|
| 群成员新增 | 有人加入目标群 | 发送**欢迎卡片**（含配置入口） | 卡片消息 |
| 卡片按钮交互 | 用户点卡片按钮 | 校验身份 → 更新状态/任务 → 回执 | 回调响应 |
| （内部定时）创建任务 | 每月 17–19 的 09:30 | 读取 `tasks.yaml` 并创建任务；记录幂等键 | 任务创建结果 |
| （内部定时）任务卡片 | 每月 18–22 的 09:31 | 汇总状态并发**月报任务卡片** | 卡片消息 |
| （内部定时）最终提醒 | 每月 23 的 09:32 | 发送最终提醒（含 `FILE_URL`、逾期清单） | 文本/卡片 |

### 3.2 时间线（每月）
- **17–19** 09:30：创建任务（幂等、跳过无负责人项、可追加协作人）  
- **18–22** 09:31：群内**月报任务卡片**（展示完成/未完成、个人入口）  
- **23** 09:32：最终提醒（附 `FILE_URL`，列逾期清单）

---

## 4. 功能需求（含验收标准）
### F1. 新成员欢迎卡片
**内容**：项目简介、当前配置摘要（时区/推送时刻/文件链接），按钮：  
- 「设置推送时刻」→ 选择时间 → 写入**群级配置**  
- 「绑定文件链接」→ 输入 `FILE_URL` → 写入群级配置  
- 「查看帮助」→ 发送说明/二级卡片  

**AC（验收）**：入群 ≤ **3s** 发出；按钮成功率 ≥ **99%**；群级配置持久化成功

### F2. 任务创建（17–19）
- 读取 `tasks.yaml`：`title/desc/due("DD HH:MM")/assignee_open_id/collaborators`
- 负责人缺失 → **跳过并记录**（在次日卡片中提示）  
- 生成 RFC3339 截止时间（跟随 TZ）  
- 幂等键：`YYYY-MM`（或 `taskKey`）；**同月只创建一次**  
- 可追加协作人（若接口版本支持）

**AC**：可创建项 **100%** 创建成功或明确记录失败项；同月重复触发不重复建；`due` 时间正确

### F3. 月报任务卡片（18–22）
**内容**：日期 + 分专业统计 + 个人清单快捷入口  
**按钮**：  
- **我已完成**：仅标记操作者负责/协作的相关任务为 `done`  
- **申请延期**：收集任务、新截止/原因 → 状态标记"延期中"  
- **查看我的清单**：机器人**私聊**未完成项（并提供"标记完成"按钮）

**AC**：09:31 ±1 分钟送达；按钮回执 ≤ **2s**；私聊内容不泄露他人任务

### F4. 最终提醒（23）
**内容**：  
- `📣 月报最终提醒：请在今天 17:00 前完成提交。文件链接：{FILE_URL}`  
- 逾期清单（责任人/任务/旧截止）

**AC**：09:32 ±1 分钟送达；链接可用；逾期清单与状态一致

---

## 5. 智能交互范围与验收（合并版）
### 5.1 覆盖的核心意图
- **查询我的任务**（"看下我今天的任务""我的清单"）  
- **标记完成**（"把发电系统那条完成""我已完成更新数据"）  
- **申请延期**（"延期到明天 17:00，原因数据未到位"）  
- **查看进度**（"今天进度怎么样""完成率多少"）  
- **指派/协作（可选）**（"把照片收集指派给@张三，截止 23 12:00"）  
- **帮助与设置**（"设置每日推送 09:00""绑定文件链接 xxx"）  

> 解析要点：时间（自然语言日期/时间）、@人（open_id 映射）、任务别名/模糊匹配（标题关键词）。

### 5.2 交互规范
- **文本优先，卡片兜底**：一句话能完成的操作优先文本；需要结构化信息时弹表单。  
- **多语言**：中/英/西语基础意图同义覆盖。  
- **安全与权限**：仅允许对"本人负责/协作"的任务进行标记或延期；越权请求明确拒绝并提示管理员通道。

### 5.3 指标与门槛（验收）
- **意图识别**：Precision ≥ **90%**，Recall ≥ **85%**；低置信度自动追问 1 次或转卡片。  
- **响应时延**：文本→回执 ≤ **2s**；写任务接口端到端 ≤ **3s**。  
- **错误率**：解析失败率 ≤ **5%**（滚动 7 日）。  
- **多语言**：三语关键词/短句覆盖 ≥ **80%** 的常见场景。  
- **回退**：识别失败或 WS 抖动时，**必有按钮/表单可完成同一操作**。

### 5.4 工程落地（最小实现）
- 模块：`smart_interaction/`（NLU、实体抽取、规则库、同义词表）、`intent_registry.json`（意图→动作映射）。  
- 流程：文本输入 → 语言检测 → 实体/意图识别 → 权限校验 → 动作执行（任务 API）→ 幂等落账 → 回执。  
- 配置：`ENABLE_NLU=true`、`INTENT_THRESHOLD=0.75`、`LANGS=["zh","en","es"]`。  
- 降级：置信度低/接口超时 → 返回含候选意图的卡片（二选一）或提示"请点卡片按钮完成操作"。

### 5.5 验收用例（抽样）
1. "我的清单" → 私聊返回本人未完成任务（含"标记完成"按钮）。  
2. "把发电系统数据更新完成" → 对应任务置 `done`，群内统计刷新。  
3. "延期到明天 17:00，原因：照片未收齐" → 更新 `due` 与 `reason`，卡片标注"延期中"。  
4. "设置每日推送 09:00" → 群级配置更新成功（卡片摘要即时刷新）。  
5. 英/西语同义表达正确返回清单。  
6. 越权操作被拒绝并提示可用路径（@管理员或查看帮助）。

---

## 6. 项目亮点（对外表述 + KPI）
1. **稳定可靠**：全链路 **WS 长连接**，心跳 + 断线重连 + 去重幂等。  
2. **技术先进**：**WS + 智能交互引擎**（意图识别、多语言、日期/人名解析）。  
3. **用户友好**：**文本优先 + 轻量卡片**双轨；零学习曲线，手机/PC 体验一致。

**可量化 KPI**
- WS 可用性 ≥ **99.9%**；断线自动重连 ≤ **30s**；重复消费率 **0**。  
- 文本意图识别 Precision ≥ **90%**；回执延迟 ≤ **2s**。  
- 用户完成关键操作的平均步骤数 ≤ **2 步**（文本或按钮任一通路）。

---

## 7. 非功能需求
- **仅 WS 回调**：单一连接、心跳、重连、回放保护；不启用 HTTP 回调。  
- **幂等与补跑**：`created_tasks["YYYY-MM"]=true`；交互去重键 `userId+taskId+action+date`；服务恢复后补跑当日环节。  
- **安全**：长连接租户级鉴权；交互携带 `nonce/timestamp`，服务做防重放；日志脱敏。  
- **观测与告警**：送达率/按钮成功率/创建成功率/完成率/WS 重连次数；WS 连续断开>3 次或 5xx 连续>3 次告警。

---

## 8. 配置与数据
### 8.1 环境变量（最小集）
```bash
# 飞书应用配置
APP_ID=cli_a8fd44a9453cd00c
APP_SECRET=jsVoFWgaaw05en6418h7xbhV5oXxAwIm
CHAT_ID=oc_07f2d3d314f00fc29baf323a3a589972

# 业务配置
FILE_URL=https://be9bhmcgo2.feishu.cn/file/Wn5AbQAmVo32OExC5zIcIiAXnKc?office_edit=1
TZ=America/Argentina/Buenos_Aires

# WebSocket 配置
WS_ENDPOINT=wss://open.feishu.cn/ws/v2
WS_HEARTBEAT_INTERVAL=30
WS_RECONNECT_MAX_ATTEMPTS=5

# 智能交互配置
ENABLE_NLU=true
INTENT_THRESHOLD=0.75
LANGS=["zh","en","es"]

# 日志与监控
LOG_LEVEL=INFO
METRICS_ENDPOINT=http://localhost:9090/metrics
```

### 8.2 数据文件
- `tasks.yaml`：任务模板（标题/描述/截止/负责人/协作人）
- `group_config.json`：群级配置覆盖（推送时刻/文件链接/时区）
- `created_tasks.json`：幂等记录（YYYY-MM → 创建状态）
- `interaction_log.json`：交互去重记录

---

## 9. 卡片与交互要素
### 9.1 欢迎卡片模板
```json
{
  "header": {
    "title": "欢迎加入月报协作群！",
    "template": "blue"
  },
  "elements": [
    {
      "tag": "div",
      "text": {
        "content": "当前配置：\n• 推送时刻：09:30\n• 时区：America/Argentina/Buenos_Aires\n• 文件链接：已配置",
        "tag": "lark_md"
      }
    },
    {
      "tag": "action_group",
      "actions": [
        {
          "tag": "button",
          "text": "设置推送时刻",
          "type": "primary",
          "value": {"action": "set_push_time"}
        },
        {
          "tag": "button", 
          "text": "绑定文件链接",
          "type": "default",
          "value": {"action": "bind_file_url"}
        },
        {
          "tag": "button",
          "text": "查看帮助",
          "type": "default", 
          "value": {"action": "show_help"}
        }
      ]
    }
  ]
}
```

### 9.2 月报任务卡片模板
```json
{
  "header": {
    "title": "📊 月报任务进度 - {date}",
    "template": "green"
  },
  "elements": [
    {
      "tag": "div",
      "fields": [
        {"is_short": true, "text": {"content": "**已完成**\n{completed_count}/{total_count}", "tag": "lark_md"}},
        {"is_short": true, "text": {"content": "**完成率**\n{completion_rate}%", "tag": "lark_md"}}
      ]
    },
    {
      "tag": "action_group",
      "actions": [
        {
          "tag": "button",
          "text": "我已完成",
          "type": "primary",
          "value": {"action": "mark_completed"}
        },
        {
          "tag": "button",
          "text": "申请延期", 
          "type": "default",
          "value": {"action": "request_extension"}
        },
        {
          "tag": "button",
          "text": "查看我的清单",
          "type": "default",
          "value": {"action": "view_my_tasks"}
        }
      ]
    }
  ]
}
```

---

## 10. 测试用例（最小集）
### 10.1 功能测试
1. **新成员入群**：模拟用户加入 → 验证欢迎卡片 3s 内发出
2. **任务创建**：17 日 09:30 → 验证 tasks.yaml 中任务全部创建成功
3. **任务卡片**：18 日 09:31 → 验证卡片内容正确，按钮响应 ≤ 2s
4. **最终提醒**：23 日 09:32 → 验证提醒内容包含 FILE_URL 和逾期清单

### 10.2 智能交互测试
1. **意图识别**："我的清单" → 私聊返回个人未完成任务
2. **权限控制**：非负责人尝试标记任务 → 拒绝并提示
3. **多语言**：英文"show my tasks" → 正确返回清单
4. **降级机制**：低置信度输入 → 返回候选意图卡片

### 10.3 非功能测试
1. **幂等性**：重复触发任务创建 → 验证不重复创建
2. **WS 重连**：模拟断线 → 验证 30s 内自动重连
3. **补跑机制**：服务重启 → 验证当日未完成环节自动补跑

---

## 11. 验收标准（KPI 总表）
| 指标类别 | 指标名称 | 目标值 | 测量方法 |
|---------|---------|--------|----------|
| **功能完整性** | 新成员欢迎成功率 | ≥ 99% | 入群事件统计 |
| | 任务创建成功率 | ≥ 95% | 17-19 日创建统计 |
| | 卡片送达率 | ≥ 99% | 18-22 日推送统计 |
| | 按钮响应成功率 | ≥ 99% | 按钮点击统计 |
| **性能指标** | 欢迎卡片延迟 | ≤ 3s | 入群到卡片时间 |
| | 按钮响应延迟 | ≤ 2s | 点击到回执时间 |
| | WS 重连时间 | ≤ 30s | 断线到重连时间 |
| **智能交互** | 意图识别准确率 | ≥ 90% | 7 日滚动统计 |
| | 多语言覆盖率 | ≥ 80% | 常见场景测试 |
| | 降级成功率 | ≥ 95% | 低置信度处理统计 |
| **稳定性** | WS 可用性 | ≥ 99.9% | 24h 连接统计 |
| | 重复消费率 | = 0% | 幂等键统计 |
| | 服务恢复时间 | ≤ 5min | 故障到恢复时间 |

---

## 12. 上线与回退
### 12.1 上线步骤
1. **预发布验证**：在测试群验证所有功能
2. **配置迁移**：备份现有配置，更新环境变量
3. **服务切换**：停止旧服务，启动新服务
4. **监控验证**：确认 WS 连接、日志、指标正常
5. **功能验证**：触发测试用例，验证关键路径

### 12.2 回退方案
- **快速回退**：5 分钟内回滚到上一版本
- **数据回退**：恢复 `group_config.json` 和 `created_tasks.json`
- **配置回退**：恢复环境变量到上一版本
- **监控告警**：回退后立即验证服务状态

---

## 13. 里程碑与交付物
| 里程碑 | 时间 | 交付物 | 验收标准 |
|--------|------|--------|----------|
| **M1: 基础架构** | Week 1 | WS 连接、心跳、重连 | 连接稳定性 ≥ 99% |
| **M2: 核心功能** | Week 2 | 欢迎卡片、任务创建、任务卡片 | 功能测试通过 |
| **M3: 智能交互** | Week 3 | NLU 引擎、多语言支持 | 意图识别 ≥ 90% |
| **M4: 集成测试** | Week 4 | 端到端测试、性能优化 | 所有 KPI 达标 |
| **M5: 生产上线** | Week 5 | 生产部署、监控告警 | 服务稳定运行 |

---

## 14. 完成定义（DoD）
### 14.1 代码完成
- [ ] 所有功能模块开发完成
- [ ] 单元测试覆盖率 ≥ 80%
- [ ] 代码审查通过
- [ ] 静态代码分析无高危问题

### 14.2 测试完成
- [ ] 功能测试用例全部通过
- [ ] 性能测试达到 KPI 要求
- [ ] 安全测试无高危漏洞
- [ ] 用户验收测试通过

### 14.3 部署完成
- [ ] 生产环境配置完成
- [ ] 监控告警配置完成
- [ ] 文档更新完成
- [ ] 运维手册交付

### 14.4 验收完成
- [ ] 所有 KPI 指标达标
- [ ] 用户培训完成
- [ ] 支持流程建立
- [ ] 项目总结报告

---

## 附录 A. 术语表
- **WS（WebSocket）**：飞书长连接回调通道
- **幂等**：同一操作多次执行结果一致
- **群级配置**：针对特定群的配置覆盖
- **补跑**：服务恢复后自动执行未完成操作
- **NLU**：自然语言理解引擎
- **RFC3339**：ISO 8601 时间格式标准

---

## 附录 B. 服务路由与权限
### B.1 权限矩阵
| 操作 | 权限要求 | 验证方式 |
|------|----------|----------|
| 查看任务 | 群成员 | 群成员身份验证 |
| 标记完成 | 任务负责人/协作人 | 任务分配关系验证 |
| 申请延期 | 任务负责人 | 任务负责人验证 |
| 配置设置 | 群管理员 | 管理员权限验证 |

### B.2 服务路由
- **WS 连接**：`wss://open.feishu.cn/ws/v2`
- **API 调用**：`https://open.feishu.cn/open-apis/`
- **文件存储**：本地 JSON 文件
- **日志输出**：标准输出 + 文件日志

---

**文档版本**：v1.1  
**最后更新**：2024年12月  
**维护者**：开发团队  
**审核状态**：待审核

