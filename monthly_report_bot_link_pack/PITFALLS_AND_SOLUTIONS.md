# æœˆæŠ¥æœºå™¨äººå¼€å‘é”™é¢˜æœ¬ (Pitfalls & Solutions)

> **ä½¿ç”¨è¯´æ˜**: æ¯æ¬¡å¼€å‘ã€éƒ¨ç½²ã€ä¿®å¤é—®é¢˜å‰ï¼Œ**å¿…é¡»å…ˆé˜…è¯»æœ¬æ–‡æ¡£**ï¼
> è¿™é‡Œè®°å½•äº†æ‰€æœ‰è¸©è¿‡çš„å‘å’Œæ­£ç¡®çš„è§£å†³æ–¹æ¡ˆã€‚é¿å…é‡å¤çŠ¯é”™ã€‚

**æœ€åæ›´æ–°**: 2025-10-24
**ç‰ˆæœ¬**: v1.1

---

## ğŸ“Œ ç›®å½•

1. [æ ¸å¿ƒæ¶æ„é—®é¢˜](#1-æ ¸å¿ƒæ¶æ„é—®é¢˜)
2. [éƒ¨ç½²ç›¸å…³é—®é¢˜](#2-éƒ¨ç½²ç›¸å…³é—®é¢˜)
3. [ç¯å¢ƒå˜é‡é—®é¢˜](#3-ç¯å¢ƒå˜é‡é—®é¢˜)
4. [é£ä¹¦APIè°ƒç”¨é—®é¢˜](#4-é£ä¹¦apiè°ƒç”¨é—®é¢˜)
5. [æ•°æ®åŒæ­¥é—®é¢˜](#5-æ•°æ®åŒæ­¥é—®é¢˜)
6. [å­—ä½“å’Œå›¾è¡¨é—®é¢˜](#6-å­—ä½“å’Œå›¾è¡¨é—®é¢˜)
7. [æœåŠ¡å™¨è¿ç»´é—®é¢˜](#7-æœåŠ¡å™¨è¿ç»´é—®é¢˜)

---

## 1. æ ¸å¿ƒæ¶æ„é—®é¢˜

### âŒ å‘ #1.1: ä½¿ç”¨æ¨¡æ‹Ÿä»»åŠ¡IDè€ŒéçœŸå®GUID

**é—®é¢˜æè¿°**:
```python
# é”™è¯¯ä»£ç  (monthly_report_bot_ws_v1.1.py:1413)
task_id = f"task_{current_month}_{success_count + 1}"  # âŒ å‡ID
logger.info("æ¨¡æ‹Ÿåˆ›å»ºä»»åŠ¡: %s (ID: %s)", task_title, task_id)
update_task_completion(task_id, task_config['title'], assignees, False)
```

**å½±å“**:
- âŒ ä»»åŠ¡çŠ¶æ€æ— æ³•ä¸é£ä¹¦åŒæ­¥
- âŒ æ¯æ—¥æé†’æ˜¾ç¤º"å·²å®Œæˆ: 0"
- âŒ å›¾è¡¨ç»Ÿè®¡æ°¸è¿œæ˜¯0%
- âŒ æ™ºèƒ½@æé†’å¤±æ•ˆ

**æ ¹æœ¬åŸå› **:
- æœ¬åœ°ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥ç”Ÿæˆå‡ID: `task_2025-10_1`
- é£ä¹¦çœŸå®ä»»åŠ¡GUIDæ ¼å¼: `b1c2d3e4-5f6a-7b8c-9d0e-1f2a3b4c5d6e`
- ç”¨å‡IDæŸ¥è¯¢é£ä¹¦APIæ—¶è¿”å›"ä»»åŠ¡ä¸å­˜åœ¨"

**âœ… æ­£ç¡®åšæ³•**:
```python
# æ­£ç¡®ä»£ç  (monthly_report_bot_ws_v1.1.py:1422-1461)
request = CreateTaskRequest.builder() \
    .request_body(CreateTaskRequestBody.builder()
                .summary(task_title)
                .description(f"æœˆåº¦æŠ¥å‘Šä»»åŠ¡: {task_config['title']}\næ–‡æ¡£é“¾æ¥: {task_config.get('doc_url', '')}")
                .due(CreateTaskRequestBodyDue.builder()
                    .timestamp(str(due_timestamp))
                    .is_all_day(False)
                    .build())
                .build()) \
    .build()

# âœ… çœŸæ­£è°ƒç”¨é£ä¹¦API
response = await lark_client.task.v2.task.acreate(request)

if response.success():
    task_guid = response.data.task.guid  # âœ… ä½¿ç”¨é£ä¹¦è¿”å›çš„çœŸå®GUID
    logger.info("âœ… ä»»åŠ¡åˆ›å»ºæˆåŠŸ: %s (GUID: %s)", task_title, task_guid)

    # âœ… ä½¿ç”¨çœŸå®GUIDä¿å­˜
    update_task_completion(task_guid, task_config['title'], assignees, False)
else:
    logger.error(f"âŒ ä»»åŠ¡åˆ›å»ºå¤±è´¥: {response.msg}")
```

**å…³é”®ç‚¹**:
1. âœ… å¿…é¡»è°ƒç”¨ `lark_client.task.v2.task.acreate(request)`
2. âœ… å¿…é¡»ä»å“åº”ä¸­æå– `response.data.task.guid`
3. âœ… å¿…é¡»ä½¿ç”¨çœŸå®GUIDä¿å­˜åˆ° `task_stats.json`
4. âœ… æœªæ¥æ‰€æœ‰ä»»åŠ¡æ“ä½œéƒ½ä½¿ç”¨è¿™ä¸ªGUID

**éªŒè¯æ–¹æ³•**:
```bash
# æ£€æŸ¥ task_stats.json ä¸­çš„ä»»åŠ¡IDæ ¼å¼
cat task_stats.json | grep "task_2025"  # ä¸åº”è¯¥æœ‰è¾“å‡º
cat task_stats.json | grep -E "[a-f0-9]{8}-[a-f0-9]{4}"  # åº”è¯¥èƒ½çœ‹åˆ°GUID
```

**ä¿®å¤æ—¶é—´**: 2025-10-23
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ æé«˜ - å¯¼è‡´æ ¸å¿ƒåŠŸèƒ½å¤±æ•ˆ

---

### âŒ å‘ #1.2: åŒæ­¥ä»»åŠ¡æ—¶ç”¨é”™è¯¯çš„API

**é—®é¢˜æè¿°**:
å°è¯•ä½¿ç”¨ `ListTaskRequest` APIåˆ—å‡ºæ‰€æœ‰ä»»åŠ¡ï¼Œä½†ä¸€ç›´å¤±è´¥ï¼š
```python
request = ListTaskRequest.builder() \
    .page_size(100) \
    .build()
response = await client.task.v2.task.alist(request)
# âŒ é”™è¯¯: code=99991668, msg=Invalid access token for authorization
```

**å½±å“**:
- âŒ æ— æ³•è·å–é£ä¹¦ä¸­çš„çœŸå®ä»»åŠ¡åˆ—è¡¨
- âŒ æ— æ³•åŒæ­¥å·²å­˜åœ¨ä»»åŠ¡çš„çŠ¶æ€

**æ ¹æœ¬åŸå› **:
- `ListTaskRequest` API éœ€è¦ç‰¹æ®Šçš„æƒé™æˆ–è®¤è¯æ–¹å¼
- å³ä½¿ APP_ID å’Œ APP_SECRET æ­£ç¡®ï¼Œä¹Ÿå¯èƒ½å› æƒé™ä¸è¶³è€Œå¤±è´¥

**âŒ é”™è¯¯å°è¯•**:
```python
# å°è¯•1: æ·»åŠ  log_level (æ— æ•ˆ)
lark_client = lark.Client.builder() \
    .app_id(APP_ID) \
    .app_secret(APP_SECRET) \
    .log_level(lark.LogLevel.ERROR) \  # âŒ æ— æ•ˆï¼Œå‚è€ƒä»£ç ä¸­æ²¡æœ‰è¿™ä¸ªå‚æ•°
    .build()

# å°è¯•2: åœ¨bashä¸­åŠ è½½ç¯å¢ƒå˜é‡ (æ— æ•ˆ)
set -a && source .env && set +a && python3 sync_existing_tasks.py
```

**âœ… æ­£ç¡®åšæ³•**:
ä½¿ç”¨ `GetTaskRequest` æŸ¥è¯¢å•ä¸ªä»»åŠ¡ï¼Œè€Œä¸æ˜¯åˆ—å‡ºæ‰€æœ‰ä»»åŠ¡ï¼š

```python
# sync_task_status_only.py
async def check_task_status(client, task_guid: str) -> int:
    """æŸ¥è¯¢å•ä¸ªä»»åŠ¡çŠ¶æ€"""
    request = GetTaskRequest.builder() \
        .task_guid(task_guid) \
        .build()

    response = await client.task.v2.task.aget(request)

    if response.success():
        task = response.data.task
        return task.complete  # 2=completed, 1=in progress
    else:
        logger.error(f"æŸ¥è¯¢å¤±è´¥: {task_guid[:20]}... (code={response.code})")
        return 0
```

**æ›´å¥½çš„æ–¹æ¡ˆ**:
å¦‚æœéœ€è¦è·å–æ‰€æœ‰ä»»åŠ¡çš„GUIDï¼Œåº”è¯¥ï¼š
1. åœ¨ä»»åŠ¡åˆ›å»ºæ—¶å°±ä¿å­˜æ­£ç¡®çš„GUIDï¼ˆä¿®å¤ #1.1 å·²è§£å†³ï¼‰
2. æˆ–è€…è®©æœ‰æƒé™çš„ç”¨æˆ·æ‰‹åŠ¨ä»é£ä¹¦webç•Œé¢è·å–ä»»åŠ¡é“¾æ¥ï¼Œä»ä¸­æå–GUID

**å…³é”®ç‚¹**:
1. âŒ ä¸è¦ä¾èµ– `ListTaskRequest` - æƒé™é—®é¢˜å¾ˆéš¾è§£å†³
2. âœ… ä½¿ç”¨ `GetTaskRequest` æŸ¥è¯¢å·²çŸ¥GUIDçš„ä»»åŠ¡
3. âœ… åœ¨åˆ›å»ºä»»åŠ¡æ—¶å°±ä¿å­˜GUIDï¼Œé¿å…åç»­éœ€è¦åˆ—å‡ºæ‰€æœ‰ä»»åŠ¡

**æ•™è®­**:
- é‡åˆ°APIæƒé™é—®é¢˜æ—¶ï¼Œä¸è¦ç›²ç›®å°è¯•å„ç§é…ç½®
- åº”è¯¥å…ˆå‚è€ƒå·²ç»éªŒè¯è¿‡çš„æ­£ç¡®ä»£ç ï¼ˆå¦‚ `monthly_report_bot_final_interactive.py`ï¼‰
- è€ƒè™‘æ›´æ¢APIç«¯ç‚¹ï¼Œè€Œä¸æ˜¯ä¸€ç›´å°è¯•ä¿®å¤åŒä¸€ä¸ªå¤±è´¥çš„API

**ä¿®å¤æ—¶é—´**: 2025-10-23
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­ç­‰ - æœ‰æ›¿ä»£æ–¹æ¡ˆ

---

## 2. éƒ¨ç½²ç›¸å…³é—®é¢˜

### âŒ å‘ #2.1: SCPä¸Šä¼ æƒé™è¢«æ‹’ç»

**é—®é¢˜æè¿°**:
```bash
$ scp monthly_report_bot_ws_v1.1.py hdi918072@34.145.43.77:/home/hdi918072/monthly_report_bot/
hdi918072@34.145.43.77: Permission denied (publickey).
```

**å½±å“**:
- âŒ æ— æ³•ç›´æ¥ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨

**æ ¹æœ¬åŸå› **:
- æœåŠ¡å™¨é…ç½®äº†SSHå¯†é’¥è®¤è¯
- æœ¬åœ°æœºå™¨æ²¡æœ‰é…ç½®æ­£ç¡®çš„SSHç§é’¥

**âŒ é”™è¯¯åšæ³•**:
å°è¯•é…ç½®SSHå¯†é’¥ï¼ˆå¤æ‚ä¸”å®¹æ˜“å‡ºé”™ï¼‰

**âœ… æ­£ç¡®åšæ³•**:
ä½¿ç”¨ GitHub ä½œä¸ºä¸­è½¬ï¼š

```bash
# 1. æ¨é€åˆ° GitHub
cd f:/monthly_report_bot_link_pack/monthly_report_bot_link_pack
git add monthly_report_bot_ws_v1.1.py sync_existing_tasks.py
git commit -m "fix: ä¿®å¤ä»»åŠ¡åŒæ­¥é—®é¢˜"
git push origin main

# 2. SSH ç™»å½•æœåŠ¡å™¨
ssh hdi918072@34.145.43.77

# 3. åœ¨æœåŠ¡å™¨ä¸Šæ‹‰å–
cd /home/hdi918072/monthly-report-bot  # âš ï¸ æ³¨æ„æ˜¯ monthly-report-bot (å¸¦è¿å­—ç¬¦)
git pull origin main
```

**å…³é”®ç‚¹**:
1. âœ… Git push/pull å·¥ä½œæµæ›´å¯é 
2. âœ… ä»£ç æœ‰ç‰ˆæœ¬æ§åˆ¶ï¼Œæ›´å®‰å…¨
3. âœ… ä¸éœ€è¦é…ç½®SSHå¯†é’¥
4. âš ï¸ æ³¨æ„ä¸è¦æŠŠæ•æ„Ÿä¿¡æ¯ï¼ˆ.envæ–‡ä»¶ï¼‰æäº¤åˆ°Git

**ç”¨æˆ·åŸè¯**:
> "ä¹‹å‰æ˜¯æ¨é€åˆ°github,ç„¶åå†google cloudä¸Šä¸‹è½½ã€‚"

**ä¿®å¤æ—¶é—´**: 2025-10-23
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¢ ä½ - æœ‰æˆç†Ÿçš„æ›¿ä»£æ–¹æ¡ˆ

---

### âŒ å‘ #2.2: æœåŠ¡å™¨ç›®å½•è·¯å¾„é”™è¯¯

**é—®é¢˜æè¿°**:
```bash
$ cd /home/hdi918072/monthly_report_bot
-bash: cd: /home/hdi918072/monthly_report_bot: No such file or directory
```

**å½±å“**:
- âŒ æ‰¾ä¸åˆ°é¡¹ç›®ç›®å½•
- âŒ æ— æ³•è¿è¡Œè„šæœ¬

**æ ¹æœ¬åŸå› **:
- å®é™…ç›®å½•åæ˜¯ `monthly-report-bot` (å¸¦è¿å­—ç¬¦ `-`)
- ä¸æ˜¯ `monthly_report_bot` (ä¸‹åˆ’çº¿ `_`)

**âœ… æ­£ç¡®è·¯å¾„**:
```bash
# âœ… æ­£ç¡®
cd /home/hdi918072/monthly-report-bot

# âŒ é”™è¯¯
cd /home/hdi918072/monthly_report_bot
```

**å…³é”®ç‚¹**:
1. âœ… ç™»å½•æœåŠ¡å™¨åå…ˆç”¨ `ls -la` ç¡®è®¤ç›®å½•å
2. âœ… ä½¿ç”¨ tab é”®è‡ªåŠ¨è¡¥å…¨ï¼Œé¿å…æ‹¼å†™é”™è¯¯
3. âœ… åœ¨è„šæœ¬ä¸­ä½¿ç”¨æ­£ç¡®çš„è·¯å¾„å¸¸é‡

**éªŒè¯æ–¹æ³•**:
```bash
# ç¡®è®¤ç›®å½•æ˜¯å¦å­˜åœ¨
ls -ld /home/hdi918072/monthly-report-bot
# åº”è¯¥è¾“å‡º: drwxr-xr-x ... /home/hdi918072/monthly-report-bot
```

**ä¿®å¤æ—¶é—´**: 2025-10-23
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¢ ä½ - å®¹æ˜“ä¿®å¤

---

### âŒ å‘ #2.3: éƒ¨ç½²è„šæœ¬å˜é‡é…ç½®é”™è¯¯

**é—®é¢˜æè¿°**:
ä¸€é”®éƒ¨ç½²è„šæœ¬ä¸­çš„æœåŠ¡å™¨é…ç½®å¯èƒ½è¿‡æ—¶æˆ–é”™è¯¯ã€‚

**å½±å“**:
- âŒ è‡ªåŠ¨åŒ–éƒ¨ç½²å¤±è´¥

**âœ… æ­£ç¡®é…ç½®**:
åœ¨ `deploy_task_sync_fix.bat` æˆ– `.sh` ä¸­ç¡®è®¤ï¼š

```bash
# æœåŠ¡å™¨é…ç½®
SERVER_USER=hdi918072
SERVER_IP=34.145.43.77
REMOTE_DIR=/home/hdi918072/monthly-report-bot  # âš ï¸ æ³¨æ„è¿å­—ç¬¦
SERVICE_NAME=monthly-report-bot  # âš ï¸ æœåŠ¡åä¹Ÿæ˜¯è¿å­—ç¬¦
```

**éªŒè¯æ–¹æ³•**:
```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ£€æŸ¥æœåŠ¡å
sudo systemctl list-units | grep monthly
# åº”è¯¥çœ‹åˆ°: monthly-report-bot.service
```

**å…³é”®ç‚¹**:
1. âœ… æœåŠ¡åå’Œç›®å½•åä¸€è‡´
2. âœ… ä½¿ç”¨è¿å­—ç¬¦ `-` è€Œä¸æ˜¯ä¸‹åˆ’çº¿ `_`
3. âœ… éƒ¨ç½²å‰å…ˆæ‰‹åŠ¨éªŒè¯ä¸€æ¬¡é…ç½®

**ä¿®å¤æ—¶é—´**: 2025-10-23
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­ç­‰ - å½±å“è‡ªåŠ¨åŒ–éƒ¨ç½²

---

## 3. ç¯å¢ƒå˜é‡é—®é¢˜

### âŒ å‘ #3.1: ç¯å¢ƒå˜é‡å‘½åæ ¼å¼é”™è¯¯

**é—®é¢˜æè¿°**:
è„šæœ¬ä¸­ä½¿ç”¨äº†é”™è¯¯çš„ç¯å¢ƒå˜é‡åï¼š
```python
# âŒ é”™è¯¯æ ¼å¼
app_id = os.environ.get('FEISHU_APP_ID')
app_secret = os.environ.get('FEISHU_APP_SECRET')
```

ä½† `.env` æ–‡ä»¶ä¸­çš„å®é™…æ ¼å¼æ˜¯ï¼š
```bash
# âœ… æ­£ç¡®æ ¼å¼
APP_ID=cli_a67920ceb9fad013
APP_SECRET=xxxxxxxxxxxxxxx
```

**å½±å“**:
- âŒ è„šæœ¬æ— æ³•è¯»å–åˆ° APP_ID å’Œ APP_SECRET
- âŒ é£ä¹¦APIè°ƒç”¨å¤±è´¥

**æ ¹æœ¬åŸå› **:
- ä¸åŒé¡¹ç›®å¯èƒ½ä½¿ç”¨ä¸åŒçš„å‘½åçº¦å®š
- æœ‰çš„ç”¨ `FEISHU_APP_ID`ï¼Œæœ‰çš„ç”¨ `APP_ID`

**ç”¨æˆ·åé¦ˆ**:
> "FEISHU_APP_ID=cli_xxxxxxxxxxxxx FEISHU_APP_SECRET=xxxxxxxxxxxxxï¼Œè¿™ä¸ªæ ¼å¼æ˜¯é”™çš„ã€‚è¯·æŸ¥è¯¢ä¸Šä¸‹æ–‡ä¸­çš„è®°å½•ï¼Œè¿™ä¸ªé—®é¢˜ä¹‹å‰é‡åˆ°å·²ç»è§£å†³äº†ä¸€æ¬¡"

**âœ… æ­£ç¡®åšæ³•**:
```python
# å…¼å®¹ä¸¤ç§æ ¼å¼
app_id = os.environ.get('APP_ID') or os.environ.get('FEISHU_APP_ID')
app_secret = os.environ.get('APP_SECRET') or os.environ.get('FEISHU_APP_SECRET')

if not app_id or not app_secret:
    print("âŒ é”™è¯¯: æœªæ‰¾åˆ° APP_ID å’Œ APP_SECRET")
    print("è¯·æ£€æŸ¥ .env æ–‡ä»¶ä¸­æ˜¯å¦åŒ…å«:")
    print("  APP_ID=cli_...")
    print("  APP_SECRET=...")
    sys.exit(1)
```

**å…³é”®ç‚¹**:
1. âœ… ä¼˜å…ˆä½¿ç”¨é¡¹ç›®çº¦å®šçš„æ ¼å¼ï¼ˆ`APP_ID`ï¼‰
2. âœ… å…¼å®¹å…¶ä»–å¯èƒ½çš„å‘½åï¼ˆ`FEISHU_APP_ID`ï¼‰
3. âœ… å¯åŠ¨æ—¶éªŒè¯ç¯å¢ƒå˜é‡æ˜¯å¦å­˜åœ¨
4. âœ… å‚è€ƒå·²éªŒè¯çš„ä»£ç ï¼ˆ`monthly_report_bot_final_interactive.py`ï¼‰

**å‚è€ƒä»£ç ** (monthly_report_bot_final_interactive.py:138-141):
```python
lark_client = lark.Client.builder() \
    .app_id(APP_ID) \
    .app_secret(APP_SECRET) \
    .build()
# âš ï¸ æ³¨æ„ï¼šæ²¡æœ‰ .log_level() å‚æ•°ï¼
```

**ä¿®å¤æ—¶é—´**: 2025-10-23
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜ - å¯¼è‡´APIè°ƒç”¨å¤±è´¥

---

### âŒ å‘ #3.2: ç¯å¢ƒå˜é‡æœªæ­£ç¡®åŠ è½½

**é—®é¢˜æè¿°**:
å³ä½¿ `.env` æ–‡ä»¶å­˜åœ¨ï¼Œè„šæœ¬ä¹Ÿå¯èƒ½æ— æ³•è¯»å–åˆ°ç¯å¢ƒå˜é‡ã€‚

**å½±å“**:
- âŒ è„šæœ¬è¿è¡Œå¤±è´¥
- âŒ æç¤ºæ‰¾ä¸åˆ° APP_ID

**âŒ é”™è¯¯å°è¯•**:
```bash
# å°è¯•åœ¨ bash å‘½ä»¤è¡Œä¸­è®¾ç½®
set -a && source .env && set +a && python3 sync_existing_tasks.py
# ç»“æœï¼šä»ç„¶å¤±è´¥
```

**æ ¹æœ¬åŸå› **:
- Pythonè„šæœ¬æ²¡æœ‰æ­£ç¡®åŠ è½½ `.env` æ–‡ä»¶
- æˆ–è€…è·¯å¾„ä¸å¯¹

**âœ… æ­£ç¡®åšæ³•**:
```python
from dotenv import load_dotenv
import os

# ç¡®ä¿ä»æ­£ç¡®çš„è·¯å¾„åŠ è½½ .env
env_path = os.path.join(os.path.dirname(__file__), '.env')
load_dotenv(env_path)

# æˆ–è€…æ˜ç¡®æŒ‡å®š .env è·¯å¾„
load_dotenv('/home/hdi918072/monthly-report-bot/.env')

# è¯»å–ç¯å¢ƒå˜é‡
APP_ID = os.environ.get('APP_ID')
APP_SECRET = os.environ.get('APP_SECRET')

# éªŒè¯
if not APP_ID:
    print(f"âŒ é”™è¯¯: .env æ–‡ä»¶è·¯å¾„: {env_path}")
    print(f"âŒ é”™è¯¯: æ–‡ä»¶æ˜¯å¦å­˜åœ¨: {os.path.exists(env_path)}")
    sys.exit(1)
```

**å…³é”®ç‚¹**:
1. âœ… ä½¿ç”¨ `python-dotenv` åº“åŠ è½½ `.env`
2. âœ… æ˜ç¡®æŒ‡å®š `.env` æ–‡ä»¶è·¯å¾„
3. âœ… æ·»åŠ è°ƒè¯•æ—¥å¿—ç¡®è®¤æ–‡ä»¶æ˜¯å¦åŠ è½½æˆåŠŸ
4. âœ… åœ¨è„šæœ¬å¼€å¤´å°±åŠ è½½å¹¶éªŒè¯ç¯å¢ƒå˜é‡

**ä¿®å¤æ—¶é—´**: 2025-10-23
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­ç­‰ - å½±å“è„šæœ¬è¿è¡Œ

---

## 4. é£ä¹¦APIè°ƒç”¨é—®é¢˜

### âŒ å‘ #4.1: é”™è¯¯æ·»åŠ ä¸å­˜åœ¨çš„å®¢æˆ·ç«¯å‚æ•°

**é—®é¢˜æè¿°**:
å°è¯•æ·»åŠ  `.log_level()` å‚æ•°æ¥è§£å†³APIè°ƒç”¨é—®é¢˜ï¼š
```python
# âŒ é”™è¯¯ä»£ç 
lark_client = lark.Client.builder() \
    .app_id(APP_ID) \
    .app_secret(APP_SECRET) \
    .log_level(lark.LogLevel.ERROR) \  # âŒ è¿™ä¸ªå‚æ•°ä¸å­˜åœ¨ï¼
    .build()
```

**å½±å“**:
- âŒ ä»£ç æ— æ³•è¿è¡Œ
- âŒ æµªè´¹æ—¶é—´è°ƒè¯•

**æ ¹æœ¬åŸå› **:
- ç›²ç›®å°è¯•å„ç§å‚æ•°ï¼Œæ²¡æœ‰å‚è€ƒå·²éªŒè¯çš„ä»£ç 
- `lark_oapi` SDK çš„ Client.builder() ä¸æ”¯æŒ `log_level()` å‚æ•°

**ç”¨æˆ·åé¦ˆ**:
> "è¯·å‚è€ƒ...ä»£ç ã€‚è¿™æ˜¯ä¹‹å‰å·²ç»éªŒè¯è¿‡çš„æ­£ç¡®æ–¹æ¡ˆï¼Œä¸è¦æ€»æ˜¯ä¸åœåœ°è¯•"

**âœ… æ­£ç¡®åšæ³•**:
å‚è€ƒå·²éªŒè¯çš„ä»£ç ï¼ˆ`monthly_report_bot_final_interactive.py:138-141`ï¼‰ï¼š
```python
# âœ… æ­£ç¡®ä»£ç ï¼ˆç®€æ´ä¸”æœ‰æ•ˆï¼‰
lark_client = lark.Client.builder() \
    .app_id(APP_ID) \
    .app_secret(APP_SECRET) \
    .build()
```

**å…³é”®ç‚¹**:
1. âœ… é‡åˆ°é—®é¢˜æ—¶ï¼Œå…ˆå‚è€ƒé¡¹ç›®ä¸­å·²éªŒè¯çš„ä»£ç 
2. âŒ ä¸è¦ç›²ç›®å°è¯•å„ç§å‚æ•°ç»„åˆ
3. âœ… å¦‚æœéœ€è¦è°ƒè¯•ï¼Œä½¿ç”¨ Python logging è€Œä¸æ˜¯ä¿®æ”¹ SDK é…ç½®
4. âœ… é˜…è¯»å®˜æ–¹æ–‡æ¡£ç¡®è®¤APIå‚æ•°

**æ•™è®­**:
- **ä¸è¦çè¯•ï¼** å…ˆçœ‹å·²æœ‰çš„æ­£ç¡®ä»£ç 
- ç”¨æˆ·æ˜ç¡®æŒ‡å‡ºè¿™æ˜¯é‡å¤çŠ¯é”™ï¼Œåº”è¯¥é¿å…

**ä¿®å¤æ—¶é—´**: 2025-10-23
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­ç­‰ - æµªè´¹æ—¶é—´

---

### âŒ å‘ #4.2: é£ä¹¦APIé”™è¯¯ç å¤„ç†ä¸å½“

**é—®é¢˜æè¿°**:
é‡åˆ°é£ä¹¦APIé”™è¯¯ç æ—¶ï¼Œæ²¡æœ‰æ­£ç¡®å¤„ç†ï¼š
```python
# é”™è¯¯ç ç¤ºä¾‹
# 99991668 - Invalid access token for authorization
# 1470400 - Task not found
```

**å½±å“**:
- âŒ ä¸çŸ¥é“é—®é¢˜çš„çœŸæ­£åŸå› 
- âŒ å°è¯•é”™è¯¯çš„ä¿®å¤æ–¹æ¡ˆ

**æ ¹æœ¬åŸå› **:
- æ²¡æœ‰ç†è§£é”™è¯¯ç çš„çœŸæ­£å«ä¹‰
- æ²¡æœ‰æ£€æŸ¥æ—¥å¿—ä¸­çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯

**âœ… æ­£ç¡®åšæ³•**:

1. **é”™è¯¯ç  99991668 (Invalid access token)**:
   - ä¸ä¸€å®šæ˜¯è®¤è¯é—®é¢˜
   - å¯èƒ½æ˜¯APIç«¯ç‚¹ä¸æ”¯æŒæˆ–æƒé™ä¸è¶³
   - åº”è¯¥å°è¯•æ¢ä¸€ä¸ªAPIç«¯ç‚¹ï¼ˆå¦‚ä» `ListTaskRequest` æ”¹ä¸º `GetTaskRequest`ï¼‰

2. **é”™è¯¯ç  1470400 (Task not found)**:
   - æ˜ç¡®è¡¨ç¤ºä»»åŠ¡ä¸å­˜åœ¨
   - è¯´æ˜ä½¿ç”¨çš„ä»»åŠ¡IDæ˜¯é”™è¯¯çš„ï¼ˆå‡IDï¼‰
   - åº”è¯¥æ£€æŸ¥ä»»åŠ¡IDçš„æ¥æºå’Œæ ¼å¼

```python
# âœ… æ­£ç¡®çš„é”™è¯¯å¤„ç†
response = await client.task.v2.task.aget(request)

if not response.success():
    error_code = response.code
    error_msg = response.msg

    if error_code == 1470400:
        # ä»»åŠ¡ä¸å­˜åœ¨ - è¯´æ˜ä»»åŠ¡IDé”™è¯¯
        logger.warning(f"ä»»åŠ¡ä¸å­˜åœ¨: {task_guid}, å¯èƒ½æ˜¯ä½¿ç”¨äº†æ¨¡æ‹ŸID")
    elif error_code == 99991668:
        # æƒé™é—®é¢˜ - è€ƒè™‘æ¢APIæˆ–æ£€æŸ¥åº”ç”¨æƒé™
        logger.error(f"APIæƒé™ä¸è¶³: {error_msg}, è€ƒè™‘ä½¿ç”¨å…¶ä»–APIç«¯ç‚¹")
    else:
        logger.error(f"æœªçŸ¥é”™è¯¯: code={error_code}, msg={error_msg}")

    return None
```

**å…³é”®ç‚¹**:
1. âœ… è®°å½•è¯¦ç»†çš„é”™è¯¯ç å’Œæ¶ˆæ¯
2. âœ… æ ¹æ®é”™è¯¯ç é‡‡å–æ­£ç¡®çš„åº”å¯¹æªæ–½
3. âœ… ä¸è¦ç›²ç›®å°è¯•ä¿®æ”¹è®¤è¯é…ç½®
4. âœ… è€ƒè™‘é—®é¢˜çš„æ ¹æœ¬åŸå› ï¼ˆå¦‚ä»»åŠ¡IDæ ¼å¼é”™è¯¯ï¼‰

**ä¿®å¤æ—¶é—´**: 2025-10-23
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­ç­‰ - å½±å“é—®é¢˜è¯Šæ–­

---

## 5. æ•°æ®åŒæ­¥é—®é¢˜

### âŒ å‘ #5.1: task_stats.json ä¸­çš„å‡IDæ— æ³•åŒæ­¥

**é—®é¢˜æè¿°**:
`task_stats.json` ä¸­å­˜å‚¨äº†23ä¸ªå‡ä»»åŠ¡IDï¼š
```json
{
  "tasks": {
    "task_2025-10_1": {...},  // âŒ å‡ID
    "task_2025-10_2": {...},  // âŒ å‡ID
    ...
  }
}
```

**å½±å“**:
- âŒ æŸ¥è¯¢é£ä¹¦APIæ—¶å…¨éƒ¨è¿”å›"ä»»åŠ¡ä¸å­˜åœ¨"
- âŒ æ— æ³•åŒæ­¥ä»»åŠ¡å®ŒæˆçŠ¶æ€
- âŒ å·²å®Œæˆçš„ä»»åŠ¡æ— æ³•ç»Ÿè®¡

**æ ¹æœ¬åŸå› **:
- åˆ›å»ºä»»åŠ¡æ—¶ä½¿ç”¨äº†æ¨¡æ‹ŸIDï¼ˆè§å‘ #1.1ï¼‰
- å¯¼è‡´æœ¬åœ°æ•°æ®ä¸é£ä¹¦æ•°æ®ä¸ä¸€è‡´

**âœ… è§£å†³æ–¹æ¡ˆ**:

**æ–¹æ¡ˆA: å¦‚æœé£ä¹¦ä¸­å­˜åœ¨çœŸå®ä»»åŠ¡**
1. ä½¿ç”¨åŒæ­¥è„šæœ¬ä»é£ä¹¦è·å–ä»»åŠ¡åˆ—è¡¨
2. æ ¹æ®ä»»åŠ¡æ ‡é¢˜åŒ¹é…
3. ç”¨çœŸå®GUIDæ›¿æ¢å‡ID

```python
# sync_existing_tasks.py
# è·å–é£ä¹¦ä»»åŠ¡ -> åŒ¹é…æ ‡é¢˜ -> æ›´æ–° task_stats.json
```

**æ–¹æ¡ˆB: å¦‚æœé£ä¹¦ä¸­ä¸å­˜åœ¨ä»»åŠ¡**
1. ä½¿ç”¨ä¿®å¤åçš„ä»£ç é‡æ–°åˆ›å»ºä»»åŠ¡
2. ä¹‹å‰çš„å®Œæˆè®°å½•å¯èƒ½éœ€è¦æ‰‹åŠ¨æ¢å¤

**å…³é”®ç‚¹**:
1. âœ… å…ˆç¡®è®¤é£ä¹¦ä¸­æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ä»»åŠ¡
2. âœ… å¦‚æœå­˜åœ¨ï¼Œå¿…é¡»è·å–çœŸå®GUID
3. âœ… æ›´æ–° `task_stats.json` æ—¶ä¿ç•™å®ŒæˆçŠ¶æ€å’Œæ—¶é—´æˆ³
4. âœ… å¤‡ä»½åŸæ–‡ä»¶ä»¥é˜²æ•°æ®ä¸¢å¤±

**éªŒè¯æ–¹æ³•**:
```bash
# æ£€æŸ¥æ›´æ–°åçš„ task_stats.json
cat task_stats.json | python3 -m json.tool | grep -A 5 "tasks"

# åº”è¯¥çœ‹åˆ° GUID æ ¼å¼è€Œä¸æ˜¯ task_2025-10_1
```

**ä¿®å¤æ—¶é—´**: 2025-10-23
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ æé«˜ - å½±å“æ ¸å¿ƒæ•°æ®ä¸€è‡´æ€§

---

### âŒ å‘ #5.2: åŒæ­¥æ—¶è¦†ç›–äº†å·²å®ŒæˆçŠ¶æ€

**é—®é¢˜æè¿°**:
åŒæ­¥ä»»åŠ¡æ—¶å¯èƒ½ä¼šé”™è¯¯åœ°è¦†ç›–æœ¬åœ°çš„å®ŒæˆçŠ¶æ€ã€‚

**å½±å“**:
- âŒ æœ¬åœ°è®°å½•çš„å·²å®Œæˆä»»åŠ¡å˜æˆæœªå®Œæˆ
- âŒ ç»Ÿè®¡æ•°æ®å›é€€

**æ ¹æœ¬åŸå› **:
- åŒæ­¥é€»è¾‘æ²¡æœ‰æ­£ç¡®å¤„ç†å·²å®ŒæˆçŠ¶æ€çš„ä¿ç•™

**âœ… æ­£ç¡®åšæ³•**:
```python
# åŒæ­¥æ—¶åº”è¯¥åˆå¹¶çŠ¶æ€ï¼Œè€Œä¸æ˜¯è¦†ç›–
def sync_task_status(local_task, feishu_task):
    """
    åˆå¹¶æœ¬åœ°å’Œé£ä¹¦çš„ä»»åŠ¡çŠ¶æ€
    è§„åˆ™ï¼šä»¥é£ä¹¦çŠ¶æ€ä¸ºå‡†ï¼Œä½†ä¿ç•™æœ¬åœ°çš„å®Œæˆæ—¶é—´æˆ³
    """
    feishu_completed = (feishu_task.complete == 2)  # 2 è¡¨ç¤ºå·²å®Œæˆ
    local_completed = local_task.get('completed', False)

    if feishu_completed:
        # é£ä¹¦æ˜¾ç¤ºå·²å®Œæˆï¼Œæ›´æ–°æœ¬åœ°çŠ¶æ€
        local_task['completed'] = True
        if not local_task.get('completed_at'):
            # å¦‚æœæœ¬åœ°æ²¡æœ‰å®Œæˆæ—¶é—´ï¼Œä½¿ç”¨å½“å‰æ—¶é—´
            local_task['completed_at'] = datetime.now().isoformat()
    elif not feishu_completed and local_completed:
        # é£ä¹¦æ˜¾ç¤ºæœªå®Œæˆï¼Œä½†æœ¬åœ°æ˜¾ç¤ºå·²å®Œæˆ
        # å¯èƒ½æ˜¯ä»»åŠ¡è¢«é‡æ–°æ‰“å¼€ï¼Œæ›´æ–°ä¸ºæœªå®Œæˆ
        logger.warning(f"ä»»åŠ¡ {local_task['title']} åœ¨é£ä¹¦ä¸­è¢«é‡æ–°æ‰“å¼€")
        local_task['completed'] = False
        local_task['completed_at'] = None

    return local_task
```

**å…³é”®ç‚¹**:
1. âœ… ä»¥é£ä¹¦çŠ¶æ€ä¸ºæƒå¨æ¥æº
2. âœ… ä¿ç•™æœ¬åœ°çš„å®Œæˆæ—¶é—´æˆ³
3. âœ… è®°å½•çŠ¶æ€å˜åŒ–çš„æ—¥å¿—
4. âœ… åŒæ­¥å‰å¤‡ä»½ `task_stats.json`

**ä¿®å¤æ—¶é—´**: 2025-10-23
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜ - å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±

---

## 6. å­—ä½“å’Œå›¾è¡¨é—®é¢˜

### âŒ å‘ #6.1: UbuntuæœåŠ¡å™¨ä¸­æ–‡ä¹±ç 

**é—®é¢˜æè¿°**:
ç”Ÿæˆçš„å›¾è¡¨ä¸­ï¼Œä¸­æ–‡æ˜¾ç¤ºä¸ºæ–¹æ¡†ä¹±ç ã€‚

**å½±å“**:
- âŒ å›¾è¡¨ä¸­æ–‡ä¸å¯è¯»
- âŒ ç”¨æˆ·ä½“éªŒå·®

**æ ¹æœ¬åŸå› **:
- UbuntuæœåŠ¡å™¨é»˜è®¤æ²¡æœ‰å®‰è£…ä¸­æ–‡å­—ä½“
- matplotlib æ‰¾ä¸åˆ°åˆé€‚çš„ä¸­æ–‡å­—ä½“

**âœ… è§£å†³æ–¹æ¡ˆ**:

**æ–¹æ³•1: å®‰è£…ç³»ç»Ÿå­—ä½“**
```bash
# å®‰è£… Noto CJK å­—ä½“
sudo apt-get update
sudo apt-get install fonts-noto-cjk

# æ¸…é™¤ matplotlib å­—ä½“ç¼“å­˜
rm -rf ~/.cache/matplotlib
```

**æ–¹æ³•2: ä½¿ç”¨è‡ªå®šä¹‰å­—ä½“æ–‡ä»¶**
```python
import matplotlib.pyplot as plt
from matplotlib.font_manager import FontProperties

# åŠ è½½è‡ªå®šä¹‰å­—ä½“
font_path = "/path/to/NotoSansCJK-Regular.ttc"
font_prop = FontProperties(fname=font_path)

# è®¾ç½®å­—ä½“
plt.rcParams['font.sans-serif'] = [font_prop.get_name()]
plt.rcParams['axes.unicode_minus'] = False
```

**æ–¹æ³•3: ç›´æ¥ä»å­—ä½“æ–‡ä»¶åŠ è½½ (æ¨è)**
```python
from matplotlib.font_manager import fontManager

# æ·»åŠ å­—ä½“æ–‡ä»¶
font_path = "./fonts/NotoSansCJK-Regular.ttc"
fontManager.addfont(font_path)

# ä½¿ç”¨å­—ä½“
plt.rcParams['font.family'] = 'Noto Sans CJK SC'
```

**å…³é”®ç‚¹**:
1. âœ… ä¼˜å…ˆä½¿ç”¨ç³»ç»Ÿå­—ä½“ï¼ˆç®€å•å¯é ï¼‰
2. âœ… å¦‚æœç³»ç»Ÿå­—ä½“ä¸å¯ç”¨ï¼Œæä¾›å­—ä½“æ–‡ä»¶
3. âœ… æµ‹è¯•æ—¶æ£€æŸ¥å›¾ç‰‡çš„ä¸­æ–‡æ˜¾ç¤º
4. âœ… æ·»åŠ å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—

**ç›¸å…³æäº¤**:
- `fdc728a` - fix: ä¿®å¤ Ubuntu æœåŠ¡å™¨ä¸Šçš„ä¸­æ–‡å­—ä½“æ˜¾ç¤ºé—®é¢˜
- `b981458` - fix: å¼ºåŒ–å­—ä½“åŠ è½½é€»è¾‘ - ç›´æ¥ä»æ–‡ä»¶åŠ è½½ Noto CJK
- `c71f9b8` - feat: æ”¯æŒè‡ªå®šä¹‰å­—ä½“æ–‡ä»¶ä¸Šä¼ 

**ä¿®å¤æ—¶é—´**: 2025-10-21 (ä¹‹å‰å·²ä¿®å¤)
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­ç­‰ - å½±å“ç”¨æˆ·ä½“éªŒ

---

### âŒ å‘ #6.2: å›¾ç‰‡ä¸Šä¼ é£ä¹¦å¤±è´¥

**é—®é¢˜æè¿°**:
ç”Ÿæˆå›¾è¡¨åä¸Šä¼ åˆ°é£ä¹¦æ—¶å¤±è´¥ã€‚

**å½±å“**:
- âŒ ç”¨æˆ·æ— æ³•çœ‹åˆ°ç»Ÿè®¡å›¾è¡¨

**å¯èƒ½åŸå› **:
1. å›¾ç‰‡äºŒè¿›åˆ¶æ•°æ®å¤„ç†ä¸å½“
2. Content-Type è®¾ç½®é”™è¯¯
3. å›¾ç‰‡æ–‡ä»¶æŸå

**âœ… è§£å†³æ–¹æ¡ˆ**:
```python
from io import BytesIO

# ç”Ÿæˆå›¾è¡¨
fig, ax = plt.subplots()
# ... ç»˜å›¾é€»è¾‘ ...

# ä¿å­˜åˆ°å†…å­˜
img_buffer = BytesIO()
plt.savefig(img_buffer, format='png', dpi=100, bbox_inches='tight')
img_buffer.seek(0)  # âš ï¸ é‡è¦ï¼šé‡ç½®æŒ‡é’ˆåˆ°å¼€å¤´

# ä¸Šä¼ åˆ°é£ä¹¦
try:
    # è¯»å–äºŒè¿›åˆ¶æ•°æ®
    img_data = img_buffer.read()

    # ä¸Šä¼ 
    request = CreateImageRequest.builder() \
        .request_body(CreateImageRequestBody.builder()
                     .image_type("message")
                     .image(img_data)  # ä¼ å…¥äºŒè¿›åˆ¶æ•°æ®
                     .build()) \
        .build()

    response = await lark_client.im.v1.image.create(request)

    if response.success():
        image_key = response.data.image_key
        logger.info(f"âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ: {image_key}")
    else:
        logger.error(f"âŒ å›¾ç‰‡ä¸Šä¼ å¤±è´¥: {response.msg}")

except Exception as e:
    logger.error(f"âŒ å›¾ç‰‡ä¸Šä¼ å¼‚å¸¸: {str(e)}", exc_info=True)
finally:
    img_buffer.close()
    plt.close(fig)  # âš ï¸ é‡Šæ”¾å›¾è¡¨èµ„æº
```

**å…³é”®ç‚¹**:
1. âœ… ä½¿ç”¨ `BytesIO` è€Œä¸æ˜¯ä¸´æ—¶æ–‡ä»¶
2. âœ… ä¸Šä¼ å‰è°ƒç”¨ `seek(0)` é‡ç½®æŒ‡é’ˆ
3. âœ… æ·»åŠ è¯¦ç»†çš„å¼‚å¸¸æ—¥å¿—
4. âœ… ä¸Šä¼ åå…³é—­ buffer å’Œå›¾è¡¨å¯¹è±¡

**ç›¸å…³æäº¤**:
- `a894b10` - fix: ä½¿ç”¨ BytesIO åŒ…è£…å›¾ç‰‡æ•°æ®å¹¶æ·»åŠ è¯¦ç»†å¼‚å¸¸æ—¥å¿—

**ä¿®å¤æ—¶é—´**: 2025-10-21 (ä¹‹å‰å·²ä¿®å¤)
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­ç­‰ - å½±å“åŠŸèƒ½å¯ç”¨æ€§

---

## 7. æœåŠ¡å™¨è¿ç»´é—®é¢˜

### âŒ å‘ #7.1: æœåŠ¡é‡å¯åé…ç½®æœªç”Ÿæ•ˆ

**é—®é¢˜æè¿°**:
ä¿®æ”¹ä»£ç åé‡å¯æœåŠ¡ï¼Œä½†ä¿®æ”¹æœªç”Ÿæ•ˆã€‚

**å½±å“**:
- âŒ æ—§ä»£ç ç»§ç»­è¿è¡Œ
- âŒ ä¿®å¤æ— æ•ˆ

**å¯èƒ½åŸå› **:
1. æ–‡ä»¶ä¸Šä¼ åˆ°é”™è¯¯çš„ç›®å½•
2. systemd ç¼“å­˜äº†æ—§çš„æœåŠ¡é…ç½®
3. Python å­—èŠ‚ç ç¼“å­˜ (`.pyc`) æœªæ›´æ–°

**âœ… è§£å†³æ–¹æ¡ˆ**:

**æ­¥éª¤1: éªŒè¯æ–‡ä»¶æ˜¯å¦æ­£ç¡®ä¸Šä¼ **
```bash
# æ£€æŸ¥æ–‡ä»¶ä¿®æ”¹æ—¶é—´
ls -lh /home/hdi918072/monthly-report-bot/monthly_report_bot_ws_v1.1.py

# æ£€æŸ¥æ–‡ä»¶å†…å®¹ï¼ˆæŸ¥çœ‹æœ€è¿‘ä¿®æ”¹çš„è¡Œï¼‰
tail -n 50 /home/hdi918072/monthly-report-bot/monthly_report_bot_ws_v1.1.py
```

**æ­¥éª¤2: æ¸…é™¤ Python å­—èŠ‚ç ç¼“å­˜**
```bash
find /home/hdi918072/monthly-report-bot -name "*.pyc" -delete
find /home/hdi918072/monthly-report-bot -name "__pycache__" -type d -exec rm -rf {} +
```

**æ­¥éª¤3: é‡æ–°åŠ è½½ systemd å¹¶é‡å¯**
```bash
sudo systemctl daemon-reload
sudo systemctl restart monthly-report-bot
sudo systemctl status monthly-report-bot
```

**æ­¥éª¤4: æŸ¥çœ‹å®æ—¶æ—¥å¿—ç¡®è®¤**
```bash
sudo journalctl -u monthly-report-bot -f
# åº”è¯¥çœ‹åˆ°æœ€æ–°çš„æ—¥å¿—è¾“å‡º
```

**å…³é”®ç‚¹**:
1. âœ… éªŒè¯æ–‡ä»¶ç¡®å®å·²æ›´æ–°
2. âœ… æ¸…é™¤ Python ç¼“å­˜
3. âœ… daemon-reload åå† restart
4. âœ… æŸ¥çœ‹æ—¥å¿—ç¡®è®¤æ–°ä»£ç è¿è¡Œ

**ä¿®å¤æ—¶é—´**: 2025-10-23
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­ç­‰ - å½±å“éƒ¨ç½²éªŒè¯

---

### âŒ å‘ #7.2: è™šæ‹Ÿç¯å¢ƒè·¯å¾„é”™è¯¯

**é—®é¢˜æè¿°**:
åœ¨æœåŠ¡å™¨ä¸Šè¿è¡ŒPythonè„šæœ¬æ—¶ï¼Œæ‰¾ä¸åˆ°ä¾èµ–åŒ…ã€‚

**å½±å“**:
- âŒ è„šæœ¬æ— æ³•è¿è¡Œ
- âŒ ImportError

**æ ¹æœ¬åŸå› **:
- æ²¡æœ‰æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
- æˆ–è€…æ¿€æ´»äº†é”™è¯¯çš„è™šæ‹Ÿç¯å¢ƒ

**âœ… æ­£ç¡®åšæ³•**:
```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd /home/hdi918072/monthly-report-bot

# 2. æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source venv/bin/activate

# 3. ç¡®è®¤ Python è·¯å¾„
which python3
# åº”è¯¥è¾“å‡º: /home/hdi918072/monthly-report-bot/venv/bin/python3

# 4. ç¡®è®¤ä¾èµ–åŒ…
pip list | grep lark-oapi

# 5. è¿è¡Œè„šæœ¬
python3 sync_existing_tasks.py
```

**å…³é”®ç‚¹**:
1. âœ… æ¯æ¬¡è¿è¡Œè„šæœ¬å‰å…ˆæ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
2. âœ… ä½¿ç”¨ `which python3` ç¡®è®¤è·¯å¾„
3. âœ… å¦‚æœä¾èµ–ç¼ºå¤±ï¼Œé‡æ–°å®‰è£…: `pip install -r requirements.txt`

**ä¿®å¤æ—¶é—´**: 2025-10-23
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¢ ä½ - å®¹æ˜“ä¿®å¤

---

### âŒ å‘ #7.3: æœåŠ¡æ—¥å¿—æ–‡ä»¶è¿‡å¤§

**é—®é¢˜æè¿°**:
é•¿æœŸè¿è¡Œåï¼Œsystemd æ—¥å¿—æ–‡ä»¶å˜å¾—éå¸¸å¤§ã€‚

**å½±å“**:
- âŒ ç£ç›˜ç©ºé—´å ç”¨
- âŒ æŸ¥çœ‹æ—¥å¿—å˜æ…¢

**âœ… è§£å†³æ–¹æ¡ˆ**:

**æŸ¥çœ‹æ—¥å¿—å¤§å°**:
```bash
sudo journalctl --disk-usage
```

**æ¸…ç†æ—§æ—¥å¿—**:
```bash
# åªä¿ç•™æœ€è¿‘7å¤©çš„æ—¥å¿—
sudo journalctl --vacuum-time=7d

# æˆ–è€…é™åˆ¶æ—¥å¿—å¤§å°ä¸º 100M
sudo journalctl --vacuum-size=100M
```

**é…ç½®æ—¥å¿—è½®è½¬**:
ç¼–è¾‘ `/etc/systemd/journald.conf`:
```ini
[Journal]
SystemMaxUse=100M
SystemMaxFileSize=10M
```

ç„¶åé‡å¯ journald:
```bash
sudo systemctl restart systemd-journald
```

**å…³é”®ç‚¹**:
1. âœ… å®šæœŸæ¸…ç†æ—§æ—¥å¿—
2. âœ… é…ç½®æ—¥å¿—å¤§å°é™åˆ¶
3. âœ… åœ¨åº”ç”¨å±‚é¢æ§åˆ¶æ—¥å¿—è¾“å‡ºé‡

**ä¿®å¤æ—¶é—´**: æœªé‡åˆ°ï¼ˆé¢„é˜²æ€§å»ºè®®ï¼‰
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¢ ä½ - è¿ç»´ä¼˜åŒ–

---

## ğŸ“ é”™è¯¯è®°å½•æ¨¡æ¿

æ¯æ¬¡é‡åˆ°æ–°çš„å‘ï¼ŒæŒ‰ç…§ä»¥ä¸‹æ¨¡æ¿è®°å½•ï¼š

```markdown
### âŒ å‘ #X.Y: [ç®€çŸ­æè¿°]

**é—®é¢˜æè¿°**:
[è¯¦ç»†æè¿°é—®é¢˜ç°è±¡ï¼ŒåŒ…æ‹¬é”™è¯¯ä¿¡æ¯]

**å½±å“**:
- âŒ [å½±å“1]
- âŒ [å½±å“2]

**æ ¹æœ¬åŸå› **:
[åˆ†æé—®é¢˜çš„æ ¹æœ¬åŸå› ]

**âŒ é”™è¯¯å°è¯•** (å¦‚æœæœ‰):
[è®°å½•å°è¯•è¿‡ä½†å¤±è´¥çš„æ–¹æ¡ˆ]

**âœ… æ­£ç¡®åšæ³•**:
[æ­£ç¡®çš„è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ä»£ç ç¤ºä¾‹]

**å…³é”®ç‚¹**:
1. âœ… [è¦ç‚¹1]
2. âœ… [è¦ç‚¹2]
3. âŒ [è¦é¿å…çš„åšæ³•]

**ç”¨æˆ·åé¦ˆ** (å¦‚æœæœ‰):
> [ç”¨æˆ·çš„åŸè¯]

**éªŒè¯æ–¹æ³•**:
[å¦‚ä½•éªŒè¯ä¿®å¤æ˜¯å¦æˆåŠŸ]

**ç›¸å…³æ–‡ä»¶**:
- [æ–‡ä»¶è·¯å¾„:è¡Œå·]

**ä¿®å¤æ—¶é—´**: YYYY-MM-DD
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ æé«˜ / ğŸŸ¡ ä¸­ç­‰ / ğŸŸ¢ ä½
```

---

## ğŸ¯ éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

æ¯æ¬¡éƒ¨ç½²æ–°ä»£ç å‰ï¼Œ**å¿…é¡»**æ£€æŸ¥ä»¥ä¸‹é¡¹ç›®ï¼š

### 1. ä»£ç æ£€æŸ¥
- [ ] æ‰€æœ‰ç¯å¢ƒå˜é‡ä½¿ç”¨æ­£ç¡®çš„å‘½åï¼ˆ`APP_ID` è€Œé `FEISHU_APP_ID`ï¼‰
- [ ] é£ä¹¦å®¢æˆ·ç«¯åˆå§‹åŒ–ä¸åŒ…å«å¤šä½™å‚æ•°ï¼ˆä¸è¦åŠ  `.log_level()`ï¼‰
- [ ] ä»»åŠ¡åˆ›å»ºä½¿ç”¨çœŸå®APIè°ƒç”¨ï¼ˆä¸æ˜¯æ¨¡æ‹Ÿï¼‰
- [ ] ä½¿ç”¨çœŸå®GUIDä¿å­˜ä»»åŠ¡ï¼ˆä¸æ˜¯æ‹¼æ¥çš„å‡IDï¼‰
- [ ] é”™è¯¯å¤„ç†å®Œæ•´ï¼ˆè®°å½•è¯¦ç»†æ—¥å¿—ï¼‰

### 2. ç¯å¢ƒæ£€æŸ¥
- [ ] `.env` æ–‡ä»¶å­˜åœ¨ä¸”åŒ…å«æ­£ç¡®çš„ APP_ID å’Œ APP_SECRET
- [ ] è™šæ‹Ÿç¯å¢ƒå·²æ¿€æ´»
- [ ] æ‰€æœ‰ä¾èµ–åŒ…å·²å®‰è£…ï¼ˆ`pip list | grep lark-oapi`ï¼‰
- [ ] Pythonç‰ˆæœ¬æ­£ç¡®ï¼ˆ`python3 --version`ï¼‰

### 3. æœåŠ¡å™¨æ£€æŸ¥
- [ ] ç›®å½•è·¯å¾„æ­£ç¡®ï¼ˆ`/home/hdi918072/monthly-report-bot`ï¼‰
- [ ] æœåŠ¡åæ­£ç¡®ï¼ˆ`monthly-report-bot`ï¼‰
- [ ] æœ‰å¤‡ä»½æ—§æ–‡ä»¶ï¼ˆ`cp xxx xxx.backup`ï¼‰
- [ ] Git ä»“åº“çŠ¶æ€å¹²å‡€ï¼ˆ`git status`ï¼‰

### 4. éƒ¨ç½²æ­¥éª¤
- [ ] æ¨é€åˆ° GitHub: `git push origin main`
- [ ] SSH ç™»å½•æœåŠ¡å™¨
- [ ] æ‹‰å–æœ€æ–°ä»£ç : `git pull origin main`
- [ ] è¿è¡ŒåŒæ­¥è„šæœ¬ï¼ˆå¦‚æœéœ€è¦ï¼‰: `python3 sync_existing_tasks.py`
- [ ] é‡å¯æœåŠ¡: `sudo systemctl restart monthly-report-bot`
- [ ] æŸ¥çœ‹æœåŠ¡çŠ¶æ€: `sudo systemctl status monthly-report-bot`
- [ ] æŸ¥çœ‹å®æ—¶æ—¥å¿—: `sudo journalctl -u monthly-report-bot -f`

### 5. éªŒè¯æµ‹è¯•
- [ ] åœ¨é£ä¹¦ç¾¤èŠå‘é€ `çŠ¶æ€` å‘½ä»¤
- [ ] æ£€æŸ¥å·²å®Œæˆä»»åŠ¡æ•°æ˜¯å¦æ­£ç¡®ï¼ˆä¸æ˜¯0ï¼‰
- [ ] å‘é€ `å›¾è¡¨` å‘½ä»¤
- [ ] æ£€æŸ¥å›¾è¡¨æ˜¯å¦æ˜¾ç¤ºæ­£ç¡®ï¼ˆä¸­æ–‡æ— ä¹±ç ï¼‰
- [ ] ç­‰å¾…ä¸‹ä¸€æ¬¡æ¯æ—¥æé†’ï¼ŒéªŒè¯æ•°æ®å‡†ç¡®æ€§

---

## ğŸ§  å…³é”®æ•™è®­

### 1. ä¸è¦ç›²ç›®å°è¯• (Don't Try Random Solutions)

**é”™è¯¯ç¤ºèŒƒ**:
- å°è¯•æ·»åŠ  `.log_level()` å‚æ•°
- å°è¯•å„ç§ç¯å¢ƒå˜é‡å‘½å
- ä¸æ–­ä¿®æ”¹è®¤è¯é…ç½®

**æ­£ç¡®åšæ³•**:
- âœ… å…ˆå‚è€ƒé¡¹ç›®ä¸­å·²éªŒè¯çš„ä»£ç 
- âœ… é˜…è¯»é”™è¯¯æ—¥å¿—ï¼Œç†è§£çœŸæ­£çš„åŸå› 
- âœ… ä¸€æ¬¡åªæ”¹ä¸€ä¸ªåœ°æ–¹ï¼ŒéªŒè¯åå†ç»§ç»­

**ç”¨æˆ·åŸè¯**:
> "ä¸è¦æ€»æ˜¯ä¸åœåœ°è¯•"

---

### 2. å‚è€ƒå·²éªŒè¯çš„ä»£ç  (Reference Proven Code)

**å…³é”®æ–‡ä»¶**:
- `monthly_report_bot_final_interactive.py` - å·²éªŒè¯çš„æ­£ç¡®å®ç°

**ç”¨æˆ·åŸè¯**:
> "è¯·å‚è€ƒ...ä»£ç ã€‚è¿™æ˜¯ä¹‹å‰å·²ç»éªŒè¯è¿‡çš„æ­£ç¡®æ–¹æ¡ˆ"
> "è¿™ä¸ªé—®é¢˜ç›´æ¥ä¹Ÿè§£å†³è¿‡ï¼Œè¯·é˜…è¯»ä¸Šä¸‹æ–‡"

**è¦ç‚¹**:
- âœ… é¡¹ç›®ä¸­å¯èƒ½å·²ç»æœ‰æ­£ç¡®çš„å®ç°
- âœ… å…ˆæœç´¢ç±»ä¼¼çš„ä»£ç 
- âœ… å¤ç”¨è€Œä¸æ˜¯é‡æ–°å‘æ˜

---

### 3. ç†è§£æ ¹æœ¬åŸå›  (Understand Root Cause)

**é”™è¯¯ç¤ºèŒƒ**:
- çœ‹åˆ°è®¤è¯é”™è¯¯å°±ä¿®æ”¹è®¤è¯é…ç½®
- çœ‹åˆ°APIå¤±è´¥å°±æ¢å„ç§å‚æ•°

**æ­£ç¡®åšæ³•**:
- âœ… é”™è¯¯ç  99991668 å¯èƒ½æ˜¯æƒé™é—®é¢˜ï¼Œè€ƒè™‘æ¢API
- âœ… é”™è¯¯ç  1470400 è¯´æ˜IDé”™è¯¯ï¼Œæ£€æŸ¥IDæ¥æº
- âœ… æ·±å…¥åˆ†æé—®é¢˜çš„æ ¹æºï¼Œè€Œä¸æ˜¯è¡¨é¢ç—‡çŠ¶

---

### 4. ä½¿ç”¨æˆç†Ÿçš„å·¥ä½œæµ (Use Proven Workflows)

**éƒ¨ç½²å·¥ä½œæµ**:
1. æœ¬åœ°å¼€å‘å’Œæµ‹è¯•
2. æ¨é€åˆ° GitHub
3. æœåŠ¡å™¨ä¸Š git pull
4. å¤‡ä»½æ—§æ–‡ä»¶
5. é‡å¯æœåŠ¡
6. éªŒè¯æ—¥å¿—

**ä¸è¦**:
- âŒ ç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šä¿®æ”¹ä»£ç 
- âŒ æ²¡æœ‰å¤‡ä»½å°±è¦†ç›–æ–‡ä»¶
- âŒ æ²¡æœ‰ç‰ˆæœ¬æ§åˆ¶

---

### 5. é˜…è¯»é”™é¢˜æœ¬ (Read This Document First)

**æ¯æ¬¡å¼€å‘å‰**:
- âœ… å…ˆé˜…è¯»æœ¬æ–‡æ¡£
- âœ… æ£€æŸ¥æ˜¯å¦æœ‰ç±»ä¼¼çš„é—®é¢˜å·²ç»è§£å†³è¿‡
- âœ… ä½¿ç”¨éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

**æ¯æ¬¡é‡åˆ°é—®é¢˜å**:
- âœ… è®°å½•åˆ°æœ¬æ–‡æ¡£
- âœ… åŒ…å«è¯¦ç»†çš„åŸå› å’Œè§£å†³æ–¹æ¡ˆ
- âœ… æ ‡æ³¨ä¸¥é‡ç¨‹åº¦å’Œä¿®å¤æ—¶é—´

---

## ğŸ“š å‚è€ƒèµ„æ–™

### é¡¹ç›®æ–‡æ¡£
- [TASK_SYNC_FIX.md](TASK_SYNC_FIX.md) - ä»»åŠ¡åŒæ­¥é—®é¢˜ä¿®å¤è¯¦ç»†è¯´æ˜
- [QUICK_FIX_GUIDE.md](QUICK_FIX_GUIDE.md) - å¿«é€Ÿä¿®å¤æŒ‡å—
- [SYNC_FIX_SUMMARY.md](SYNC_FIX_SUMMARY.md) - ä¿®å¤æ€»ç»“
- [COMPLETE_FEATURES_AND_SUMMARY.md](COMPLETE_FEATURES_AND_SUMMARY.md) - åŠŸèƒ½å®Œæˆæ€»ç»“

### å·²éªŒè¯çš„ä»£ç 
- `monthly_report_bot_final_interactive.py` - å‚è€ƒå®ç°
- `monthly_report_bot_ws_v1.1.py` - å½“å‰ç‰ˆæœ¬ï¼ˆå·²ä¿®å¤ï¼‰

### å·¥å…·è„šæœ¬
- `sync_existing_tasks.py` - ä»»åŠ¡åŒæ­¥å·¥å…·
- `deploy_task_sync_fix.bat` - Windows éƒ¨ç½²è„šæœ¬
- `deploy_task_sync_fix.sh` - Linux/Mac éƒ¨ç½²è„šæœ¬

### é£ä¹¦å¼€æ”¾å¹³å°
- [é£ä¹¦å¼€æ”¾å¹³å°æ–‡æ¡£](https://open.feishu.cn/document/)
- [ä»»åŠ¡API v2 æ–‡æ¡£](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/task-v2/task/overview)
- [lark-oapi SDK](https://github.com/larksuite/oapi-sdk-python)

---

### âŒ å‘ #6.3: matplotlib æ ·å¼è¦†ç›–å­—ä½“é…ç½®

**é—®é¢˜æè¿°**:
è®¾ç½®äº†ä¸­æ–‡å­—ä½“åï¼Œå›¾è¡¨ä¸­çš„ä¸­æ–‡ä»ç„¶æ˜¾ç¤ºä¸ºæ–¹å—ä¹±ç ã€‚

**å½±å“**:
- âŒ å›¾è¡¨æ ‡é¢˜ã€æ ‡ç­¾ä¸­æ–‡æ˜¾ç¤ºå¼‚å¸¸
- âŒ ç”¨æˆ·ä½“éªŒå·®

**æ ¹æœ¬åŸå› **:
```python
# chart_generator.py
setup_chinese_fonts()  # Line 85 - è®¾ç½® SimHei å­—ä½“
sns.set_style("whitegrid")  # Line 88
plt.style.use('seaborn-v0_8')  # Line 89 - âŒ è¦†ç›–äº†å­—ä½“é…ç½®ï¼
```

`plt.style.use()` ä¼šé‡ç½® matplotlib çš„æ‰€æœ‰ rcParamsï¼ŒåŒ…æ‹¬å­—ä½“è®¾ç½®ã€‚å¯¼è‡´ä¹‹å‰é…ç½®çš„ SimHei å­—ä½“å¤±æ•ˆï¼Œå›é€€åˆ° DejaVu Sansã€‚

**æ—¥å¿—è¯æ®**:
```
INFO:chart_generator:âœ… ä½¿ç”¨è‡ªå®šä¹‰å­—ä½“: simhei  # å­—ä½“åŠ è½½æˆåŠŸ
UserWarning: Glyph 20219 (\N{CJK UNIFIED IDEOGRAPH-4EFB}) missing from font(s) DejaVu Sans  # ä½†å®é™…ä½¿ç”¨ DejaVu Sans
```

**âœ… æ­£ç¡®åšæ³•**:
åœ¨æ ·å¼è®¾ç½®**ä¹‹å**é‡æ–°åº”ç”¨å­—ä½“é…ç½®ï¼š

```python
# chart_generator.py

# æ‰§è¡Œå­—ä½“é…ç½®
setup_chinese_fonts()

# è®¾ç½®å›¾è¡¨æ ·å¼
sns.set_style("whitegrid")
plt.style.use('seaborn-v0_8')

# é‡æ–°åº”ç”¨å­—ä½“é…ç½®ï¼ˆæ ·å¼å¯èƒ½ä¼šè¦†ç›–ï¼‰
setup_chinese_fonts()  # âœ… å…³é”®ï¼šå†æ¬¡è°ƒç”¨ç¡®ä¿å­—ä½“ç”Ÿæ•ˆ
```

**å…³é”®ç‚¹**:
1. âœ… `plt.style.use()` ä¼šé‡ç½®å­—ä½“é…ç½®
2. âœ… å¿…é¡»åœ¨ style.use() **ä¹‹å**å†æ¬¡è°ƒç”¨å­—ä½“é…ç½®
3. âœ… æ¸…é™¤ matplotlib ç¼“å­˜: `rm -rf ~/.cache/matplotlib`
4. âœ… éªŒè¯æ–¹æ³•ï¼šæ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦æœ‰ "missing from font(s) DejaVu Sans"

**ç›¸å…³æäº¤**:
- `3478da5` - fix: é‡æ–°åº”ç”¨å­—ä½“é…ç½®é˜²æ­¢æ ·å¼è¦†ç›–

**ä¿®å¤æ—¶é—´**: 2025-10-24
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜ - å¯¼è‡´æ ¸å¿ƒåŠŸèƒ½æ˜¾ç¤ºå¼‚å¸¸

---

### âŒ å‘ #6.4: SimHei å­—ä½“ä¸æ”¯æŒ Emoji

**é—®é¢˜æè¿°**:
å›¾è¡¨ä¸­çš„ emoji å­—ç¬¦ï¼ˆğŸ†ğŸ¥‡ğŸ¥ˆğŸ“ŠğŸ“ˆï¼‰æ˜¾ç¤ºä¸ºæ–¹å—ä¹±ç ï¼Œä½†æ™®é€šä¸­æ–‡æ˜¾ç¤ºæ­£å¸¸ã€‚

**å½±å“**:
- âŒ ä»»åŠ¡å®Œæˆæ’åçš„å¥–ç‰Œ emoji æ— æ³•æ˜¾ç¤º
- âŒ å›¾è¡¨è£…é¥°æ€§å›¾æ ‡æ˜¾ç¤ºå¼‚å¸¸
- âŒ éƒ¨åˆ†UIå…ƒç´ ç¼ºå¤±

**æ ¹æœ¬åŸå› **:
SimHei (é»‘ä½“) å­—ä½“åªåŒ…å«ä¸­æ–‡å­—ç¬¦ï¼Œ**ä¸åŒ…å« emoji å­—ç¬¦**ã€‚

**æ—¥å¿—è¯æ®**:
```
UserWarning: Glyph 127942 (\N{TROPHY}) missing from font(s) SimHei
UserWarning: Glyph 128202 (\N{BAR CHART}) missing from font(s) SimHei
UserWarning: Glyph 9989 (\N{WHITE HEAVY CHECK MARK}) missing from font(s) SimHei
```

**ç”¨æˆ·åé¦ˆ**:
> "æˆ‘çº¢è‰²åœˆå‡ºæ¥é‚£ä¸€éƒ¨åˆ†ä¹±ç ï¼ŒåŸæ¥åº”è¯¥è¦æ˜¾ç¤ºå®Œæˆä»»åŠ¡æ’åçš„é‡‘ç‰Œã€é“¶ç‰Œçš„ã€‚ç°åœ¨æ˜¾ç¤ºçš„ä¹±ç "

**âœ… æ­£ç¡®åšæ³•**:
é…ç½®å­—ä½“å›é€€é“¾ï¼Œæ·»åŠ  emoji å­—ä½“æ”¯æŒï¼š

```python
# chart_generator.py

if simhei_fonts:
    font_prop = fm.FontProperties(fname=simhei_fonts[0])
    font_name = font_prop.get_name()
    logger.info(f"ä½¿ç”¨ SimHei å­—ä½“: {font_name}")
    # æ·»åŠ  emoji å­—ä½“ä½œä¸ºåå¤‡
    plt.rcParams['font.sans-serif'] = [
        font_name,           # ä¸­æ–‡ä½¿ç”¨ SimHei
        'Symbola',           # emoji ä½¿ç”¨ Symbola
        'Noto Color Emoji',  # æˆ– Noto Color Emoji
        'DejaVu Sans'        # æœ€åçš„åå¤‡å­—ä½“
    ]
```

**å­—ä½“ä¼˜å…ˆçº§**:
1. **SimHei** - å¤„ç†ä¸­æ–‡å­—ç¬¦ (âœ… ä¸­æ–‡)
2. **Symbola** - å¤„ç† emoji å’Œç¬¦å· (âœ… ğŸ†ğŸ“Š)
3. **Noto Color Emoji** - å½©è‰² emoji æ”¯æŒ
4. **DejaVu Sans** - è‹±æ–‡å’Œæ•°å­—

**å…³é”®ç‚¹**:
1. âœ… å•ä¸ªå­—ä½“æ— æ³•åŒæ—¶æ”¯æŒä¸­æ–‡å’Œ emoji
2. âœ… ä½¿ç”¨å­—ä½“å›é€€é“¾ (font fallback chain)
3. âœ… ç¡®ä¿æœåŠ¡å™¨å®‰è£…äº† emoji å­—ä½“: `apt install fonts-symbola`
4. âœ… æ¸…é™¤ matplotlib ç¼“å­˜åæµ‹è¯•

**éªŒè¯æ–¹æ³•**:
```bash
# æ£€æŸ¥ç³»ç»Ÿæ˜¯å¦æœ‰ emoji å­—ä½“
fc-list | grep -i symbola
fc-list | grep -i emoji

# è¯·æ±‚æ–°å›¾è¡¨æµ‹è¯•
# åœ¨é£ä¹¦å‘é€: @æœˆæŠ¥æ”¶é›†ç³»ç»Ÿ å›¾è¡¨
```

**ç›¸å…³æäº¤**:
- `095bfb9` - fix: æ·»åŠ  emoji å­—ä½“æ”¯æŒè§£å†³å›¾è¡¨ä¸­ emoji ä¹±ç é—®é¢˜

**ä¿®å¤æ—¶é—´**: 2025-10-24
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­ç­‰ - å½±å“è§†è§‰æ•ˆæœå’Œç”¨æˆ·ä½“éªŒ

---

### âŒ å‘ #6.5: setup_chinese_fonts() åœ¨æ¨¡å—å¯¼å…¥æ—¶è°ƒç”¨ä½†é…ç½®æœªåœ¨å›¾è¡¨æ¸²æŸ“æ—¶ç”Ÿæ•ˆ

**é—®é¢˜æè¿°**:
å°½ç®¡å·²ç»é…ç½®äº† Symbola emoji å­—ä½“å›é€€é“¾ï¼ˆå‘ #6.4ï¼‰ï¼Œå¹¶åœ¨æ¨¡å—å¯¼å…¥æ—¶è°ƒç”¨äº† `setup_chinese_fonts()`ï¼Œä½†å›¾è¡¨æ¸²æŸ“æ—¶ emoji ä»ç„¶æ˜¾ç¤ºä¸ºæ–¹å—ï¼Œæ—¥å¿—ä¸­ä»ç„¶æ˜¾ç¤º "Glyph ... missing from font(s) SimHei"ã€‚

**å½±å“**:
- âŒ æ’åå¥–ç‰Œ emoji (ğŸ¥‡ğŸ¥ˆğŸ¥‰) æ˜¾ç¤ºä¸ºæ–¹å—
- âŒ æ‰€æœ‰å›¾è¡¨è£…é¥°æ€§ emoji å¼‚å¸¸
- âŒ å°½ç®¡å¤šæ¬¡æ¸…é™¤ matplotlib ç¼“å­˜å’Œé‡å¯æœåŠ¡ä»ç„¶æ— æ•ˆ

**æ ¹æœ¬åŸå› **:
`setup_chinese_fonts()` åªåœ¨ä»¥ä¸‹ä¸¤ä¸ªæ—¶æœºè¢«è°ƒç”¨ï¼š
1. æ¨¡å—å¯¼å…¥æ—¶ï¼ˆchart_generator.py é¡¶å±‚ä»£ç ï¼‰
2. ChartGenerator.__init__() åˆå§‹åŒ–æ—¶

ä½†è¿™ä¸¤ä¸ªè°ƒç”¨éƒ½å‘ç”Ÿåœ¨**å®é™…å›¾è¡¨æ¸²æŸ“ä¹‹å‰**ï¼Œå­—ä½“é…ç½®åœ¨åç»­çš„ matplotlib æ“ä½œä¸­å¯èƒ½è¢«é‡ç½®æˆ–ä¸ç”Ÿæ•ˆã€‚

**æ—¥å¿—è¯æ®**:
```bash
# æœåŠ¡å¯åŠ¨æ—¶çœ‹ä¸åˆ°ä»»ä½•å­—ä½“é…ç½®æ—¥å¿—
sudo journalctl -u monthly-report-bot -n 50
# æ²¡æœ‰ "å¼€å§‹é…ç½®ä¸­æ–‡å’Œ emoji å­—ä½“" çš„è¾“å‡º

# å›¾è¡¨ç”Ÿæˆæ—¶ä»ç„¶æ˜¾ç¤ºå­—ä½“ç¼ºå¤±
Oct 27 19:16:26 monthly-report-bot python3[696879]: UserWarning: Glyph 127942 (\N{TROPHY}) missing from font(s) SimHei.
Oct 27 19:16:26 monthly-report-bot python3[696879]: UserWarning: Glyph 128202 (\N{BAR CHART}) missing from font(s) SimHei.
```

**ç”¨æˆ·åé¦ˆ**:
> "å›¾è¡¨å³ä¾§æ’åå‹‹ç« ï¼ˆğŸ¥‡ğŸ¥ˆğŸ¥‰ï¼‰æ˜¾ç¤ºä¹±ç çš„é—®é¢˜ã€‚è¿˜æœªè§£å†³"
> "ä»æœªæ­£ç¡®æ˜¾ç¤º"ï¼ˆå¤šæ¬¡éƒ¨ç½²åä»ç„¶å¤±è´¥ï¼‰

**âœ… æ­£ç¡®åšæ³•**:
åœ¨**æ¯ä¸ªå›¾è¡¨ç”Ÿæˆæ–¹æ³•çš„å¼€å§‹å¤„**è°ƒç”¨ `setup_chinese_fonts()`ï¼Œç¡®ä¿å­—ä½“é…ç½®åœ¨æ¯æ¬¡æ¸²æŸ“å‰éƒ½è¢«åº”ç”¨ï¼š

```python
# chart_generator.py

def generate_comprehensive_dashboard(self, stats: Dict[str, Any]) -> str:
    """ç”Ÿæˆç¾åŒ–ç‰ˆç»¼åˆä»ªè¡¨æ¿"""
    try:
        # âœ… å…³é”®ä¿®å¤ï¼šåœ¨æ¯æ¬¡ç”Ÿæˆå›¾è¡¨å‰éƒ½é‡æ–°åº”ç”¨å­—ä½“é…ç½®
        setup_chinese_fonts()

        # åç»­å›¾è¡¨ç”Ÿæˆä»£ç ...
        fig = plt.figure(figsize=(18, 12))
        # ...

def generate_task_completion_pie_chart(self, stats: Dict[str, Any]) -> str:
    """ç”Ÿæˆä»»åŠ¡å®Œæˆæƒ…å†µé¥¼çŠ¶å›¾"""
    try:
        # âœ… ç¡®ä¿å­—ä½“é…ç½®åœ¨æ¯æ¬¡ç”Ÿæˆå›¾è¡¨å‰éƒ½è¢«åº”ç”¨
        setup_chinese_fonts()

        # åç»­å›¾è¡¨ç”Ÿæˆä»£ç ...

# åŒæ ·åº”ç”¨åˆ°æ‰€æœ‰å…¶ä»–å›¾è¡¨ç”Ÿæˆæ–¹æ³•:
# - generate_user_participation_chart()
# - generate_progress_trend_chart()
```

**ä¸ºä»€ä¹ˆè¿™æ ·æœ‰æ•ˆ**:
1. âœ… æ¯æ¬¡è°ƒç”¨éƒ½ä¼šé‡æ–°æ³¨å†Œ Symbola å­—ä½“åˆ° FontManager
2. âœ… æ¯æ¬¡éƒ½ä¼šé‡æ–°è®¾ç½® `plt.rcParams['font.sans-serif']` å­—ä½“å›é€€é“¾
3. âœ… ç¡®ä¿åœ¨ä»»ä½•å¯èƒ½é‡ç½®å­—ä½“é…ç½®çš„æ“ä½œï¼ˆå¦‚ `plt.style.use()`ï¼‰ä¹‹åéƒ½èƒ½æ¢å¤æ­£ç¡®é…ç½®
4. âœ… ä¸ä¾èµ–æ¨¡å—å¯¼å…¥æ—¶çš„ä¸€æ¬¡æ€§é…ç½®

**å…³é”®ç‚¹**:
1. âŒ **ä¸è¦**åªåœ¨æ¨¡å—å¯¼å…¥æˆ–ç±»åˆå§‹åŒ–æ—¶é…ç½®å­—ä½“
2. âœ… **åº”è¯¥**åœ¨æ¯ä¸ªå®é™…ç»˜å›¾æ–¹æ³•å¼€å§‹æ—¶é…ç½®å­—ä½“
3. âœ… å­—ä½“é…ç½®æ˜¯å¹‚ç­‰çš„ï¼Œå¤šæ¬¡è°ƒç”¨ä¸ä¼šæœ‰å‰¯ä½œç”¨
4. âœ… è¿™æ˜¯ç¡®ä¿é…ç½®ç”Ÿæ•ˆçš„æœ€å¯é æ–¹å¼

**è°ƒè¯•æŠ€å·§**:
```bash
# éªŒè¯ setup_chinese_fonts() æ˜¯å¦è¢«è°ƒç”¨
sudo journalctl -u monthly-report-bot -f | grep "å¼€å§‹é…ç½®ä¸­æ–‡å’Œ emoji å­—ä½“"

# éªŒè¯ Symbola å­—ä½“æ˜¯å¦æˆåŠŸåŠ è½½
sudo journalctl -u monthly-report-bot -f | grep "æˆåŠŸåŠ è½½ Symbola"

# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å­—ä½“ç¼ºå¤±è­¦å‘Š
sudo journalctl -u monthly-report-bot -f | grep "missing from font"
```

**ç›¸å…³æäº¤**:
- `f409649` - fix: call setup_chinese_fonts in ChartGenerator.__init__ to ensure fonts are configured

**ä¿®å¤æ—¶é—´**: 2025-10-27
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜ - è¿™æ˜¯å‘ #6.4 çš„æ ¹æœ¬è§£å†³æ–¹æ¡ˆ

**æ•™è®­**:
- matplotlib çš„å­—ä½“é…ç½®æ˜¯æœ‰çŠ¶æ€çš„ï¼Œéœ€è¦åœ¨ä½¿ç”¨å‰ç¡®ä¿çŠ¶æ€æ­£ç¡®
- æ¨¡å—çº§åˆ«çš„ä¸€æ¬¡æ€§é…ç½®ä¸å¯é ï¼Œåº”è¯¥åœ¨æ¯æ¬¡ä½¿ç”¨æ—¶é…ç½®
- å½“å‘ç°æ—¥å¿—ä¸­æ²¡æœ‰é¢„æœŸçš„è¾“å‡ºæ—¶ï¼Œè¯´æ˜ä»£ç æ ¹æœ¬æ²¡æœ‰è¢«æ‰§è¡Œåˆ°
- å­—ä½“é…ç½®åº”è¯¥"å°±è¿‘åŸåˆ™"ï¼šåœ¨ä½¿ç”¨ä¹‹å‰ç«‹å³é…ç½®

---

## ğŸ†• æ–°å¢é”™è¯¯è®°å½•åŒº

_(æ¯æ¬¡é‡åˆ°æ–°é—®é¢˜åï¼Œåœ¨è¿™é‡Œæ·»åŠ è®°å½•ï¼Œç„¶åç§»åŠ¨åˆ°å¯¹åº”çš„ç« èŠ‚)_

### âŒ å‘ #1.3: APIç±»åé”™è¯¯å¯¼è‡´ä»£ç æœªçœŸæ­£ç”Ÿæ•ˆ

**å‘ç°æ—¶é—´**: 2025-10-27

**é—®é¢˜æè¿°**:
å°½ç®¡ä¹‹å‰ä¿®å¤äº†å‘ #1.1ï¼ˆä½¿ç”¨æ¨¡æ‹ŸIDé—®é¢˜ï¼‰ï¼Œä½†ä»£ç ä¸­ä½¿ç”¨äº†é”™è¯¯çš„APIç±»åï¼Œå¯¼è‡´ä»£ç æ— æ³•è¿è¡Œï¼Œä¿®å¤æœªçœŸæ­£ç”Ÿæ•ˆï¼š

```python
# âŒ é”™è¯¯çš„ç±»åï¼ˆSDKä¸­ä¸å­˜åœ¨ï¼‰
CreateTaskRequestBody.builder()
CreateTaskRequestBodyDue.builder()
CreateTaskRequestBodyOrigin.builder()
CreateTaskCollaboratorRequest.builder()
```

**å½±å“**:
- âŒ ä»£ç æ— æ³•è¿è¡Œï¼ŒæŠ›å‡º AttributeError
- âŒ ä»»åŠ¡æ— æ³•åˆ›å»º
- âŒ task_stats.json ä¸­ä»ç„¶æ˜¯å‡ID (task_2025-10_1)
- âŒ å·²å®Œæˆä»»åŠ¡æ•°æ˜¾ç¤ºä¸º 0

**æ ¹æœ¬åŸå› **:
1. æ²¡æœ‰å‚è€ƒ SESSION_SUMMARY_2025-10-23.md ä¸­è®°å½•çš„æ­£ç¡®APIç±»å
2. æ ¹æ®å‘ #4.1 çš„æ•™è®­ï¼šä¸è¦ç›²ç›®å°è¯•ï¼Œåº”è¯¥å‚è€ƒå·²éªŒè¯çš„ä»£ç 
3. ä¿®å¤ä»£ç æ—¶æ²¡æœ‰å®é™…æµ‹è¯•æ˜¯å¦èƒ½è¿è¡Œ

**âœ… æ­£ç¡®åšæ³•**:
å‚è€ƒ SESSION_SUMMARY_2025-10-23.md ä¸­çš„æ­£ç¡®APIï¼š

```python
from lark_oapi.api.task.v2 import CreateTaskRequest
from lark_oapi.api.task.v2.model import InputTask, Due, Member

# å‡†å¤‡æˆå‘˜ï¼ˆåœ¨åˆ›å»ºæ—¶ç›´æ¥åˆ†é…ï¼‰
members_list = []
for assignee_id in assignees:
    member = Member.builder() \
        .id(assignee_id) \
        .role("assignee") \
        .build()
    members_list.append(member)

# åˆ›å»ºä»»åŠ¡è¯·æ±‚
request = CreateTaskRequest.builder() \
    .request_body(InputTask.builder()
        .summary(title)
        .description(description)
        .due(Due.builder()
            .timestamp(str(timestamp))
            .is_all_day(False)
            .build())
        .members(members_list)  # ç›´æ¥åœ¨åˆ›å»ºæ—¶åˆ†é…æˆå‘˜
        .build()) \
    .build()

response = await lark_client.task.v2.task.acreate(request)
task_guid = response.data.task.guid  # âœ… è·å–çœŸå®GUID
```

**å…³é”®ç‚¹**:
1. âœ… ä½¿ç”¨ `InputTask` è€Œé `CreateTaskRequestBody`
2. âœ… ä½¿ç”¨ `Due` è€Œé `CreateTaskRequestBodyDue`
3. âœ… ä½¿ç”¨ `Member` API åœ¨åˆ›å»ºæ—¶ç›´æ¥åˆ†é…æˆå‘˜
4. âœ… ä¸ä½¿ç”¨ `Origin`ï¼ˆéå¿…éœ€ä¸”å®¹æ˜“å‡ºé”™ï¼‰
5. âœ… ä¸åœ¨åˆ›å»ºåå•ç‹¬åˆ†é…æˆå‘˜ï¼ˆé¿å…ä½¿ç”¨ CreateTaskCollaboratorRequestï¼‰

**æ¸…ç†å‡IDçš„æ–¹æ³•**:
åˆ›å»ºäº† `clear_fake_task_ids.py` è„šæœ¬ï¼š
```bash
# æ¸…ç† task_stats.json ä¸­çš„å‡ID
python3 clear_fake_task_ids.py

# åˆ é™¤åˆ›å»ºè®°å½•ï¼Œè®©ç³»ç»Ÿé‡æ–°åˆ›å»ºä»»åŠ¡
rm created_tasks.json

# é‡å¯æœåŠ¡
sudo systemctl restart monthly-report-bot
```

**éªŒè¯æ–¹æ³•**:
```bash
# æ£€æŸ¥ task_stats.json ä¸­çš„IDæ ¼å¼
cat task_stats.json | python3 -c "import json, sys; data=json.load(sys.stdin); tasks=data.get('tasks', {}); print('å‡ID:', sum(1 for k in tasks if k.startswith('task_'))); print('çœŸå®GUID:', sum(1 for k in tasks if not k.startswith('task_')))"

# åº”è¯¥è¾“å‡ºï¼š
# å‡ID: 0
# çœŸå®GUID: 24
```

**ç”¨æˆ·åé¦ˆ**:
ç”¨æˆ·æä¾›æˆªå›¾æ˜¾ç¤º"å·²å®Œæˆ: 0"ï¼Œæ˜ç¡®è¡¨ç¤º"ä»æœªä¿®å¤æˆåŠŸ"

**ä¿®å¤æ—¶é—´**: 2025-10-27
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ æé«˜ - ä¹‹å‰çš„ä¿®å¤æœªçœŸæ­£ç”Ÿæ•ˆ

**å…³è”å‘**:
- å‘ #1.1: ä½¿ç”¨æ¨¡æ‹Ÿä»»åŠ¡IDè€ŒéçœŸå®GUIDï¼ˆæ ¹æºé—®é¢˜ï¼‰
- å‘ #4.1: é”™è¯¯æ·»åŠ ä¸å­˜åœ¨çš„å®¢æˆ·ç«¯å‚æ•°ï¼ˆç›¸åŒçš„"ç›²ç›®å°è¯•"é”™è¯¯ï¼‰
- å‘ #5.1: task_stats.json ä¸­çš„å‡IDæ— æ³•åŒæ­¥ï¼ˆåæœï¼‰

---

<!--
æ¨¡æ¿ï¼š

### âŒ å‘ #X.Y: [é—®é¢˜ç®€è¿°]

**å‘ç°æ—¶é—´**: YYYY-MM-DD
**é—®é¢˜æè¿°**: ...
**è§£å†³æ–¹æ¡ˆ**: ...
**å…³é”®è¦ç‚¹**: ...

-->

---

**æé†’**:
- ğŸš¨ æ¯æ¬¡å¼€å‘å‰å…ˆé˜…è¯»æœ¬æ–‡æ¡£
- ğŸš¨ é‡åˆ°é—®é¢˜æ—¶å…ˆæœç´¢æœ¬æ–‡æ¡£
- ğŸš¨ è§£å†³æ–°é—®é¢˜ååŠæ—¶æ›´æ–°æœ¬æ–‡æ¡£

**æ–‡æ¡£ç»´æŠ¤**:
- å®šæœŸå®¡æŸ¥å’Œå½’ç±»æ–°å¢çš„é”™è¯¯è®°å½•
- æ›´æ–°ä¸¥é‡ç¨‹åº¦å’Œä¿®å¤çŠ¶æ€
- æ·»åŠ æ›´å¤šéªŒè¯æ–¹æ³•å’Œæµ‹è¯•ç”¨ä¾‹
