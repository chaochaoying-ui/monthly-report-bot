# 月报机器人开发总结（v1.3）

## 一、问题与坑点复盘

1. SDK 版本兼容性
   - 坑点：lark-oapi>=2.0.0 在当前环境不可用，导致依赖安装失败。
   - 规避：降级为 lark-oapi>=1.4.22，代码对 SDK 缺失做 Graceful Degrade（允许仅运行本地逻辑与单测）。

2. 任务状态同步 400/1470400
   - 坑点：使用本地模拟 Task GUID（如 task_YYYY-MM_N）查询真实 API 返回 400/1470400，产生冗余警告与无意义请求。
   - 规避：对模拟 ID 采用本地回退；远端返回 1470400 时降级读取本地状态，避免重复请求。

3. @提及文本无法触发帮助
   - 坑点：消息中包含 “@机器人 帮助” 或富文本 <at ...>帮助 时，原逻辑按原文回声，未识别“帮助”。
   - 规避：新增 _sanitize_command_text，统一剔除富文本/纯文本@提及并标准化空白与大小写，再做意图匹配。

4. 事件循环关闭后的协程投递
   - 坑点：WS 在 loop 关闭后仍 run_coroutine_threadsafe，触发 “Event loop is closed” 与 “coroutine was never awaited”。
   - 规避：仅当 loop.is_running() 且未关闭时才调度；对 Future 添加回调捕获异常，避免静默失败。

5. SDK 未注册处理器的后台事件噪声
   - 坑点：application.* 事件输出 “processor not found” error，污染日志。
   - 规避：增加日志过滤器，统一降级为 info 并忽略错误级别输出。

6. 定时同步对真实 GUID 依赖
   - 坑点：本地/演示环境使用模拟 ID，直接查询真实接口无意义。
   - 规避：同步前先识别模拟 ID 并采取本地状态，减少外部依赖。

## 二、功能增强点

- 新增多意图文案：状态/进度/统计/完成率、未完成/谁没交/任务列表、文件/链接/模板/地址、截止/时间/提醒/什么时候、已完成/完成了/done。
- 帮助文案更清晰，指引如何查看状态、列表、时间安排与完成操作。

## 三、测试策略

- 单测覆盖：
  - 文本清理（@提及富文本/纯文本）与帮助触发
  - 状态/未完成/文件/时间/完成说明等意图回复
  - 本地任务状态回退与 1470400 降级逻辑
- 运行：pytest -q（已在 Windows PowerShell 下验证）

## 四、对后续开发的建议（给产品/项目方）

1. 依赖与环境
   - 在 CI 中锁定 lark-oapi 与 python 版本，并提供离线包或企业镜像源。
   - 将 requirements_ws.txt 作为默认安装入口，统一依赖集合。

2. 事件与权限
   - 只订阅实际需要的事件，避免 application.* 等非业务事件。
   - 补充权限校验脚本（现有 scripts/check_event_subscription.py 可扩展）。

3. 配置与运行模式
   - 使用 .env 管理机密配置；不同环境（dev/test/prod）分层加载。
   - 在 README 中明确“演示/本地/线上”三种运行说明与差异（是否使用真实 Task GUID）。

4. 质量保障
   - 将 pytest、ruff/flake8、black 纳入 CI；提交前本地预检。
   - 对关键网络调用增加重试与限流策略，并落盘审计日志便于追踪。

5. 用户交互与可用性
   - 继续扩充常见问句同义词词典，并引入轻量 NLU（可配置阈值与兜底回复）。
   - 为“标记完成”提供按钮/卡片交互方案，减少用户记忆负担。

## 五、回退说明

- 如需回退：恢复以下文件至变更前版本即可：
  - monthly_report_bot_final_interactive.py
  - monthly_report_bot_final.py
  - requirements_ws.txt
  - tests/test_interactive_echo.py

---
最后，感谢提出“丰富文本回复、总结坑点”的需求，这对提高系统的可维护性和团队协作效率非常关键。欢迎继续补充更多实际问句样例，我们可以按数据驱动迭代交互体验。








