# â° å®šæ—¶ä»»åŠ¡é…ç½®æ€»ç»“

**æ›´æ–°æ—¥æœŸ**: 2025-11-11
**ç‰ˆæœ¬**: v1.3.2
**çŠ¶æ€**: âœ… å·²æŒ‰éœ€æ±‚è°ƒæ•´å®Œæ¯•

---

## ğŸ“‹ å®šæ—¶ä»»åŠ¡é…ç½®å¯¹ç…§

| æ—¶é—´ | æ—¥æœŸèŒƒå›´ | åŠŸèƒ½ | çŠ¶æ€ |
|------|----------|------|------|
| **09:30** | 17æ—¥ | åˆ›å»ºå½“æœˆä»»åŠ¡ | âœ… å·²é…ç½® |
| **09:30** | 18-23æ—¥ | æ¯æ—¥æé†’ï¼ˆ@æœªå®Œæˆè´Ÿè´£äººï¼‰| âœ… å·²é…ç½® |
| **17:00** | 18-23æ—¥ | å‘é€ç»Ÿè®¡å¡ç‰‡+å›¾è¡¨ | âœ… æ–°å¢ |
| **17:00** | 23æ—¥ | æœ€ç»ˆå‚¬åŠå’Œç»Ÿè®¡ | âœ… å·²é…ç½® |

---

## ğŸ†• æœ¬æ¬¡æ›´æ–°å†…å®¹

### 1. è°ƒæ•´æ—¶é—´ç‚¹

**ä»»åŠ¡åˆ›å»º**
- ä¿®æ”¹å‰: 17æ—¥ 09:00
- ä¿®æ”¹å: 17æ—¥ 09:30
- æ–‡ä»¶: `monthly_report_bot_ws_v1.1.py:1296`
- å‡½æ•°: `should_create_tasks()`

**æ¯æ—¥æé†’**
- ä¿®æ”¹å‰: 18-23æ—¥ 09:00
- ä¿®æ”¹å: 18-23æ—¥ 09:30
- æ–‡ä»¶: `monthly_report_bot_ws_v1.1.py:1305`
- å‡½æ•°: `should_send_daily_reminder()`

### 2. æ–°å¢åŠŸèƒ½ï¼šæ¯æ—¥ç»Ÿè®¡ï¼ˆ17:00ï¼‰

**æ–°å¢å‡½æ•°**ï¼š

1. **`should_send_daily_stats()`** (ç¬¬ 1307 è¡Œ)
   - åˆ¤æ–­æ˜¯å¦åº”è¯¥å‘é€æ¯æ—¥ç»Ÿè®¡
   - è§¦å‘æ¡ä»¶: 18-23æ—¥ ä¸”æ—¶é—´ä¸º 17:00
   ```python
   return 18 <= current_day <= 23 and current_time == "17:00"
   ```

2. **`build_daily_stats_card()`** (ç¬¬ 615 è¡Œ)
   - æ„å»ºæ¯æ—¥ç»Ÿè®¡å¡ç‰‡
   - åŒ…å«å®Œæˆç‡ã€è¿›åº¦æ¡ã€ç»Ÿè®¡æ•°æ®
   - ä½¿ç”¨è“è‰²ä¸»é¢˜
   ```python
   {
       "header": {
           "title": "ğŸ“Š ä»Šæ—¥å®Œæˆæƒ…å†µç»Ÿè®¡",
           "template": "blue"
       }
   }
   ```

3. **`send_image_to_chat()`** (ç¬¬ 777 è¡Œ)
   - å‘é€å›¾ç‰‡åˆ°ç¾¤èŠï¼ˆä½œä¸ºå¡ç‰‡å½¢å¼ï¼‰
   - ä¸Šä¼ å›¾ç‰‡è·å– image_key
   - æ„å»ºåŒ…å«å›¾ç‰‡çš„å¡ç‰‡å¹¶å‘é€
   ```python
   async def send_image_to_chat(image_path: str, title: str = "å›¾ç‰‡") -> bool
   ```

**ä¸»å¾ªç¯é›†æˆ** (ç¬¬ 1361-1374 è¡Œ)ï¼š
```python
elif should_send_daily_stats(now):
    logger.info("å‘é€æ¯æ—¥ç»Ÿè®¡ï¼ˆ17:00ï¼Œå®Œæˆæƒ…å†µ+å›¾è¡¨ï¼‰...")
    await sync_task_completion_status()

    # å‘é€ç»Ÿè®¡å¡ç‰‡
    stats = load_task_stats()
    card = build_daily_stats_card(stats)
    await send_card_to_chat(card)

    # ç”Ÿæˆå¹¶å‘é€å›¾è¡¨
    try:
        from chart_generator import chart_generator
        chart_path = chart_generator.generate_comprehensive_dashboard(stats)
        await send_image_to_chat(chart_path, "ğŸ“Š ä»Šæ—¥å®Œæˆæƒ…å†µç»Ÿè®¡å›¾è¡¨")
    except Exception as e:
        logger.error(f"ç”Ÿæˆå›¾è¡¨å¤±è´¥: {e}")
```

### 3. æ›´æ–°å¸®åŠ©æ–‡æ¡£

**æ—¶é—´å®‰æ’è¯´æ˜** (ç¬¬ 997-1000 è¡Œ)ï¼š
```
â° æ—¶é—´å®‰æ’

- 17æ—¥ 09:30ï¼šåˆ›å»ºå½“æœˆä»»åŠ¡
- 18-23æ—¥ 09:30ï¼šå‘é€æ¯æ—¥æé†’ï¼ˆ@æœªå®Œæˆè´Ÿè´£äººï¼‰
- 18-23æ—¥ 17:00ï¼šå‘é€ç»Ÿè®¡å¡ç‰‡+å›¾è¡¨
- 23æ—¥ 17:00ï¼šå‘é€æœ€ç»ˆå‚¬åŠå’Œç»Ÿè®¡
```

---

## ğŸ“Š æ¯æ—¥ç»Ÿè®¡åŠŸèƒ½è¯¦è§£

### æ‰§è¡Œæµç¨‹

1. **åˆ¤æ–­è§¦å‘** (17:00)
   ```
   18 <= day <= 23 ä¸” time == "17:00"
   ```

2. **åŒæ­¥ä»»åŠ¡çŠ¶æ€**
   ```python
   await sync_task_completion_status()
   ```

3. **åŠ è½½ç»Ÿè®¡æ•°æ®**
   ```python
   stats = load_task_stats()
   ```

4. **å‘é€ç»Ÿè®¡å¡ç‰‡**
   - åŒ…å«å®Œæˆç‡ã€è¿›åº¦æ¡
   - æ€»ä»»åŠ¡æ•°ã€å·²å®Œæˆã€æœªå®Œæˆ
   - ç»Ÿè®¡æ—¶é—´æˆ³

5. **ç”Ÿæˆå›¾è¡¨**
   ```python
   chart_generator.generate_comprehensive_dashboard(stats)
   ```

6. **å‘é€å›¾è¡¨**
   - ä½œä¸ºå¡ç‰‡å½¢å¼å‘é€
   - åŒ…å«æ ‡é¢˜"ğŸ“Š ä»Šæ—¥å®Œæˆæƒ…å†µç»Ÿè®¡å›¾è¡¨"

### å¡ç‰‡æ ·å¼

```json
{
  "header": {
    "title": "ğŸ“Š ä»Šæ—¥å®Œæˆæƒ…å†µç»Ÿè®¡",
    "template": "blue"
  },
  "elements": [
    {
      "tag": "div",
      "text": {
        "tag": "lark_md",
        "content": "**2025-10 æœˆæŠ¥ä»»åŠ¡è¿›å±•**\n\nâœ… **ä»Šæ—¥å®Œæˆæƒ…å†µè‰¯å¥½ï¼**\n\nğŸ“ˆ **å®Œæˆæƒ…å†µ**:\nâ€¢ æ€»ä»»åŠ¡æ•°: 23\nâ€¢ å·²å®Œæˆ: 6\nâ€¢ æœªå®Œæˆ: 17\nâ€¢ å®Œæˆç‡: 26%\n\nğŸ“Š **è¿›åº¦æ¡**:\n`â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘` 26%\n\nâ° ç»Ÿè®¡æ—¶é—´: 2025-11-11 17:00:00\n\nğŸ’¡ **æç¤º**: å›¾è¡¨å°†éšåå‘é€"
      }
    }
  ]
}
```

### å›¾è¡¨å†…å®¹

- ğŸ“Š ç»¼åˆä»ªè¡¨æ¿
- ğŸ“ˆ ä»»åŠ¡å®Œæˆè¶‹åŠ¿
- ğŸ‘¥ å®Œæˆäººå‘˜æ’è¡Œ
- ğŸ¯ å®Œæˆç‡åˆ†æ
- ğŸ“‰ ä»»åŠ¡çŠ¶æ€åˆ†å¸ƒ

---

## ğŸ”„ ä¸åŸéœ€æ±‚å¯¹æ¯”

### éœ€æ±‚æ–‡æ¡£

| é¡¹ç›® | éœ€æ±‚è¦æ±‚ | å½“å‰å®ç° | çŠ¶æ€ |
|------|----------|----------|------|
| ä»»åŠ¡åˆ›å»º | 17æ—¥ 09:30 | 17æ—¥ 09:30 | âœ… ç¬¦åˆ |
| æ¯æ—¥æé†’ | 18-23æ—¥ 09:30 | 18-23æ—¥ 09:30 | âœ… ç¬¦åˆ |
| æ¯æ—¥ç»Ÿè®¡ | 18-23æ—¥ 17:00 | 18-23æ—¥ 17:00 | âœ… ç¬¦åˆ |
| æœ€ç»ˆæé†’ | 23æ—¥ 17:00 | 23æ—¥ 17:00 | âœ… ç¬¦åˆ |

### å®Œæˆåº¦

- âœ… **å®šæ—¶æ—¶é—´**: 100% ç¬¦åˆéœ€æ±‚
- âœ… **åŠŸèƒ½å®ç°**: 100% å®Œæ•´
- âœ… **æ–‡æ¡£æ›´æ–°**: 100% åŒæ­¥

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### å•å…ƒæµ‹è¯•

**æµ‹è¯• `should_send_daily_stats()`**:
```python
from datetime import datetime
import pytz

TZ = pytz.timezone("America/Argentina/Buenos_Aires")

# æµ‹è¯•æ¡ˆä¾‹1: 18æ—¥ 17:00 - åº”è¯¥è§¦å‘
now = datetime(2025, 10, 18, 17, 0, tzinfo=TZ)
assert should_send_daily_stats(now) == True

# æµ‹è¯•æ¡ˆä¾‹2: 18æ—¥ 16:59 - ä¸åº”è¯¥è§¦å‘
now = datetime(2025, 10, 18, 16, 59, tzinfo=TZ)
assert should_send_daily_stats(now) == False

# æµ‹è¯•æ¡ˆä¾‹3: 23æ—¥ 17:00 - åº”è¯¥è§¦å‘
now = datetime(2025, 10, 23, 17, 0, tzinfo=TZ)
assert should_send_daily_stats(now) == True

# æµ‹è¯•æ¡ˆä¾‹4: 17æ—¥ 17:00 - ä¸åº”è¯¥è§¦å‘ï¼ˆä¸åœ¨18-23èŒƒå›´ï¼‰
now = datetime(2025, 10, 17, 17, 0, tzinfo=TZ)
assert should_send_daily_stats(now) == False
```

### é›†æˆæµ‹è¯•

**æ‰‹åŠ¨è§¦å‘æµ‹è¯•**:
```python
# åœ¨æµ‹è¯•ç¯å¢ƒä¸´æ—¶ä¿®æ”¹åˆ¤æ–­é€»è¾‘
def should_send_daily_stats(now: Optional[datetime] = None) -> bool:
    return True  # å¼ºåˆ¶è§¦å‘

# é‡å¯æœåŠ¡ï¼Œè§‚å¯Ÿæ—¥å¿—
# åº”è¯¥çœ‹åˆ°ï¼š
# - "å‘é€æ¯æ—¥ç»Ÿè®¡ï¼ˆ17:00ï¼Œå®Œæˆæƒ…å†µ+å›¾è¡¨ï¼‰..."
# - "ç¾åŒ–ç‰ˆç»¼åˆä»ªè¡¨æ¿å·²ç”Ÿæˆ: charts/dashboard_XXX.png"
# - "å›¾ç‰‡ä¸Šä¼ æˆåŠŸ, image_key: img_v3_XXX"
# - "å¡ç‰‡å‘é€æˆåŠŸ"
```

---

## ğŸ“ éƒ¨ç½²æ­¥éª¤

### 1. æ›´æ–°ä»£ç 

```bash
cd /home/hdi918072/monthly-report-bot/monthly_report_bot_link_pack
git pull
```

é¢„æœŸè¾“å‡º:
```
remote: Enumerating objects: 7, done.
Updating 23e2088..58c26da
 monthly_report_bot_ws_v1.1.py | 127 ++++++++++++++++++++++++++++-----
 1 file changed, 116 insertions(+), 11 deletions(-)
```

### 2. éªŒè¯ä»£ç 

```bash
# æ£€æŸ¥å…³é”®å‡½æ•°æ˜¯å¦å­˜åœ¨
grep -n "def should_send_daily_stats" monthly_report_bot_ws_v1.1.py
grep -n "def build_daily_stats_card" monthly_report_bot_ws_v1.1.py
grep -n "def send_image_to_chat" monthly_report_bot_ws_v1.1.py
```

### 3. é‡å¯æœåŠ¡

```bash
sudo systemctl restart monthly-report-bot
```

### 4. æŸ¥çœ‹æ—¥å¿—

```bash
sudo journalctl -u monthly-report-bot -f
```

é¢„æœŸçœ‹åˆ°:
```
å¯åŠ¨æœˆæŠ¥æœºå™¨äººä¸»å¾ªç¯ï¼ˆäº¤äº’å¢å¼ºç‰ˆï¼‰
å½“å‰æ—¶é—´: 2025-11-11 XX:XX:XX
```

### 5. ç­‰å¾…è§¦å‘æˆ–æ‰‹åŠ¨æµ‹è¯•

**ç­‰å¾…è‡ªåŠ¨è§¦å‘**:
- 18-23æ—¥ 17:00 ä¼šè‡ªåŠ¨å‘é€ç»Ÿè®¡

**æ‰‹åŠ¨æµ‹è¯•**ï¼ˆåœ¨æµ‹è¯•ç¾¤ï¼‰:
- å‘é€å‘½ä»¤è§¦å‘å›¾è¡¨ç”Ÿæˆï¼š`è¿›åº¦å›¾è¡¨` æˆ– `/chart`
- éªŒè¯å›¾è¡¨ç”ŸæˆåŠŸèƒ½æ˜¯å¦æ­£å¸¸

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ—¶åŒºè®¾ç½®

ç¡®ä¿ç¯å¢ƒå˜é‡ `TZ` è®¾ç½®ä¸ºé˜¿æ ¹å»·æ—¶åŒºï¼š
```bash
echo $TZ
# åº”è¾“å‡º: America/Argentina/Buenos_Aires
```

### 2. å›¾è¡¨ç”Ÿæˆä¾èµ–

ç¡®ä¿ chart_generator æ¨¡å—æ­£å¸¸ï¼š
```bash
python3 -c "from chart_generator import chart_generator; print('OK')"
```

### 3. ä»»åŠ¡æ•°æ®

ç¡®ä¿ `task_stats.json` å­˜åœ¨ä¸”æœ‰æ•°æ®ï¼š
```bash
cat task_stats.json | head -20
```

### 4. æ—¥å¿—ç›‘æ§

å®šæ—¶ä»»åŠ¡è§¦å‘æ—¶ä¼šæœ‰æ—¥å¿—ï¼š
```
å‘é€æ¯æ—¥ç»Ÿè®¡ï¼ˆ17:00ï¼Œå®Œæˆæƒ…å†µ+å›¾è¡¨ï¼‰...
ç¾åŒ–ç‰ˆç»¼åˆä»ªè¡¨æ¿å·²ç”Ÿæˆ: charts/dashboard_XXX.png
å›¾ç‰‡ä¸Šä¼ æˆåŠŸ, image_key: img_v3_XXX
å¡ç‰‡å‘é€æˆåŠŸ
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: 17:00 æ²¡æœ‰å‘é€ç»Ÿè®¡

**æ£€æŸ¥**:
1. ç¡®è®¤å½“å‰æ—¥æœŸåœ¨ 18-23 æ—¥èŒƒå›´å†…
2. æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
3. æŸ¥çœ‹æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯

**è§£å†³**:
```bash
# æ£€æŸ¥æ—¥æœŸ
date
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status monthly-report-bot
# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u monthly-report-bot -n 50
```

### é—®é¢˜ 2: å›¾è¡¨ç”Ÿæˆå¤±è´¥

**ç—‡çŠ¶**: å‘é€äº†å¡ç‰‡ä½†æ²¡æœ‰å›¾è¡¨

**æ£€æŸ¥**:
```bash
# æ£€æŸ¥å›¾è¡¨ç›®å½•
ls -la charts/
# æ£€æŸ¥æ—¥å¿—ä¸­çš„é”™è¯¯
sudo journalctl -u monthly-report-bot | grep "ç”Ÿæˆå›¾è¡¨å¤±è´¥"
```

**è§£å†³**: æŸ¥çœ‹ [NEXT_STEPS_2025-11-11.md](NEXT_STEPS_2025-11-11.md) ä¸­çš„ Emoji å­—ä½“ä¿®å¤æ–¹æ¡ˆ

### é—®é¢˜ 3: å›¾ç‰‡ä¸Šä¼ å¤±è´¥

**ç—‡çŠ¶**: å›¾è¡¨ç”Ÿæˆäº†ä½†ä¸Šä¼ å¤±è´¥

**æ£€æŸ¥**:
```bash
# æ£€æŸ¥ç½‘ç»œè¿æ¥
ping open.feishu.cn
# æ£€æŸ¥å›¾ç‰‡æ–‡ä»¶
ls -lh charts/*.png
```

---

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### å…³é”®æ—¥å¿—

**æˆåŠŸçš„æ—¥å¿—**:
```
å‘é€æ¯æ—¥ç»Ÿè®¡ï¼ˆ17:00ï¼Œå®Œæˆæƒ…å†µ+å›¾è¡¨ï¼‰...
åŒæ­¥ä»»åŠ¡å®ŒæˆçŠ¶æ€æˆåŠŸ
ç¾åŒ–ç‰ˆç»¼åˆä»ªè¡¨æ¿å·²ç”Ÿæˆ: charts/dashboard_20251111_170000.png
å›¾ç‰‡ä¸Šä¼ æˆåŠŸ, image_key: img_v3_02ri_xxxxx
å¡ç‰‡å‘é€æˆåŠŸ
```

**å¤±è´¥çš„æ—¥å¿—**:
```
ç”Ÿæˆå›¾è¡¨å¤±è´¥: [é”™è¯¯ä¿¡æ¯]
å›¾ç‰‡ä¸Šä¼ å¤±è´¥, code: XX, msg: XXX
å¡ç‰‡å‘é€å¤±è´¥, code: XX, msg: XXX
```

### æ€§èƒ½æŒ‡æ ‡

- ç»Ÿè®¡å¡ç‰‡å‘é€: < 2 ç§’
- å›¾è¡¨ç”Ÿæˆ: < 5 ç§’
- å›¾ç‰‡ä¸Šä¼ : < 3 ç§’
- æ€»è€—æ—¶: < 10 ç§’

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [PRE_PRODUCTION_CHECKLIST.md](PRE_PRODUCTION_CHECKLIST.md) - éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•
- [DEPLOYMENT_DECISION_REPORT.md](DEPLOYMENT_DECISION_REPORT.md) - éƒ¨ç½²å†³ç­–æŠ¥å‘Š
- [NEXT_STEPS_2025-11-11.md](NEXT_STEPS_2025-11-11.md) - Emoji å­—ä½“ä¿®å¤
- [éœ€æ±‚å®ç°å¯¹ç…§è¡¨.md](éœ€æ±‚å®ç°å¯¹ç…§è¡¨.md) - å®Œæ•´åŠŸèƒ½å¯¹ç…§

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-11-11 14:30 (UTC+8)
**ç»´æŠ¤è€…**: Claude Code Assistant
